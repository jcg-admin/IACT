#!/bin/bash
# scripts/git-hooks/pre-rebase
# Prevents rebasing of protected branches
# Reference: ESTRATEGIA_GIT_HOOKS.md
# Inspired by: Git official pre-rebase hook example

set -euo pipefail

# Protected branches (cannot be rebased)
readonly PROTECTED_BRANCHES="main develop"

basebranch="$1"
topic="${2:-HEAD}"

# Get current branch
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "detached")

echo ""
echo "PRE-REBASE CHECK"
echo "================"
echo "Rebasing: $current_branch onto $basebranch"
echo ""

# ============================================================================
# CHECK 1: NO REBASE OF PROTECTED BRANCHES
# ============================================================================

for protected in $PROTECTED_BRANCHES; do
    if [ "$current_branch" = "$protected" ]; then
        echo "ERROR: Cannot rebase protected branch: $protected"
        echo ""
        echo "Protected branches should not be rebased."
        echo "This would rewrite published history."
        echo ""
        echo "Instead:"
        echo "  1. Create a feature branch:"
        echo "     git checkout -b feature/my-feature"
        echo ""
        echo "  2. Work on feature branch"
        echo ""
        echo "  3. Merge back to $protected:"
        echo "     git checkout $protected"
        echo "     git merge feature/my-feature"
        echo ""
        exit 1
    fi
done

# ============================================================================
# CHECK 2: WARN IF BRANCH ALREADY PUBLISHED
# ============================================================================

if git branch -r | grep -q "origin/$current_branch"; then
    echo "WARNING: Branch '$current_branch' exists on remote"
    echo ""
    echo "Rebasing a published branch rewrites history and may"
    echo "cause issues for other developers who have pulled this branch."
    echo ""
    echo "Consequences:"
    echo "  - Other developers will have conflicts"
    echo "  - Force push required (dangerous)"
    echo "  - Lost commits if not careful"
    echo ""
    echo "Safer alternatives:"
    echo "  1. Merge instead of rebase:"
    echo "     git merge $basebranch"
    echo ""
    echo "  2. Create new branch:"
    echo "     git checkout -b ${current_branch}-rebased"
    echo "     git rebase $basebranch"
    echo ""

    read -p "Continue rebasing anyway? [y/N] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Rebase cancelled."
        exit 1
    fi
fi

# ============================================================================
# CHECK 3: WARN IF REBASING ONTO DIFFERENT BRANCH
# ============================================================================

# Get branch's upstream
upstream=$(git rev-parse --abbrev-ref "$current_branch@{upstream}" 2>/dev/null || echo "none")

if [ "$upstream" != "none" ] && [ "$basebranch" != "${upstream#origin/}" ]; then
    echo "WARNING: Rebasing onto different branch"
    echo ""
    echo "Current branch: $current_branch"
    echo "Tracks: $upstream"
    echo "Rebasing onto: $basebranch"
    echo ""
    echo "This may not be what you want."
    echo ""

    read -p "Continue? [y/N] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Rebase cancelled."
        exit 1
    fi
fi

# ============================================================================
# ALL CHECKS PASSED
# ============================================================================

echo "Rebase allowed. Proceeding..."
exit 0
