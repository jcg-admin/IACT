#!/bin/bash
# scripts/git-hooks/pre-commit
# Pre-commit hook with 5 fast validations
# Reference: ESTRATEGIA_GIT_HOOKS.md

set -euo pipefail

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Source common functions if available
if [ -f "$PROJECT_ROOT/scripts/lib/common.sh" ]; then
    source "$PROJECT_ROOT/scripts/lib/common.sh"
else
    log_info() { echo "[INFO] $*"; }
    log_success() { echo "[SUCCESS] $*"; }
    log_error() { echo "[ERROR] $*" >&2; }
    log_warning() { echo "[WARNING] $*" >&2; }
fi

FAILED=0

echo ""
echo "PRE-COMMIT VALIDATIONS"
echo "======================"
echo ""

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    log_info "No files staged for commit"
    exit 0
fi

# ============================================================================
# VALIDATION 1: NO EMOJIS (CRITICAL)
# ============================================================================

echo "[1/5] Checking for emojis..."
if python "$PROJECT_ROOT/scripts/workflows/check_no_emojis.py" $STAGED_FILES; then
    log_success "No emojis found"
else
    log_error "Emojis detected (see above)"
    FAILED=$((FAILED + 1))
fi

# ============================================================================
# VALIDATION 2: SHELL SCRIPT SYNTAX
# ============================================================================

echo ""
echo "[2/5] Checking shell script syntax..."
SHELL_ERRORS=0

for file in $STAGED_FILES; do
    if [[ "$file" == *.sh ]]; then
        if ! bash -n "$file" 2>/dev/null; then
            log_error "Syntax error in: $file"
            SHELL_ERRORS=$((SHELL_ERRORS + 1))
        fi
    fi
done

if [ $SHELL_ERRORS -eq 0 ]; then
    log_success "Shell syntax OK"
else
    log_error "Shell syntax errors found in $SHELL_ERRORS file(s)"
    FAILED=$((FAILED + 1))
fi

# ============================================================================
# VALIDATION 3: PYTHON SYNTAX
# ============================================================================

echo ""
echo "[3/5] Checking Python syntax..."
PYTHON_ERRORS=0

for file in $STAGED_FILES; do
    if [[ "$file" == *.py ]]; then
        if ! python -m py_compile "$file" 2>/dev/null; then
            log_error "Syntax error in: $file"
            PYTHON_ERRORS=$((PYTHON_ERRORS + 1))
        fi
    fi
done

if [ $PYTHON_ERRORS -eq 0 ]; then
    log_success "Python syntax OK"
else
    log_error "Python syntax errors found in $PYTHON_ERRORS file(s)"
    FAILED=$((FAILED + 1))
fi

# ============================================================================
# VALIDATION 4: NO DEBUG STATEMENTS
# ============================================================================

echo ""
echo "[4/5] Checking for debug statements..."
DEBUG_FOUND=0

for file in $STAGED_FILES; do
    if [[ "$file" == *.py ]]; then
        if grep -nE "import pdb|breakpoint\(\)|print\('DEBUG" "$file" 2>/dev/null; then
            log_warning "Debug statement found in: $file"
            DEBUG_FOUND=$((DEBUG_FOUND + 1))
        fi
    fi

    if [[ "$file" == *.sh ]]; then
        if grep -n "set -x" "$file" 2>/dev/null | grep -v "^#"; then
            log_warning "Debug mode (set -x) found in: $file"
            DEBUG_FOUND=$((DEBUG_FOUND + 1))
        fi
    fi
done

if [ $DEBUG_FOUND -eq 0 ]; then
    log_success "No debug statements"
else
    log_warning "Debug statements found in $DEBUG_FOUND file(s) (review before commit)"
fi

# ============================================================================
# VALIDATION 5: FILE SIZE CHECK
# ============================================================================

echo ""
echo "[5/5] Checking file sizes..."
LARGE_FILES=0

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ "$size" -gt 1048576 ]; then  # 1MB
            log_error "File too large: $file ($(($size / 1024))KB > 1024KB)"
            LARGE_FILES=$((LARGE_FILES + 1))
        fi
    fi
done

if [ $LARGE_FILES -eq 0 ]; then
    log_success "File sizes OK"
else
    log_error "Large files found: $LARGE_FILES (max: 1MB)"
    FAILED=$((FAILED + 1))
fi

# ============================================================================
# SUMMARY
# ============================================================================

echo ""
echo "======================"
if [ $FAILED -eq 0 ]; then
    log_success "PRE-COMMIT PASSED"
    echo ""
    exit 0
else
    log_error "PRE-COMMIT FAILED: $FAILED validation(s) failed"
    echo ""
    echo "Fix the issues above and try again."
    echo ""
    echo "To bypass (NOT recommended):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
