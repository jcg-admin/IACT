# -*- mode: ruby -*-
# vi: set ft=ruby :

# =============================================================================
# IACT CPython Builder - Vagrant Configuration
# =============================================================================
# Purpose: VM configuration for CPython compilation environment
# =============================================================================

VAGRANTFILE_API_VERSION = "2"

# =============================================================================
# CONFIGURATION VARIABLES
# =============================================================================

# VM Configuration
VM_NAME = "iact-cpython-builder"
VM_HOSTNAME = "cpython-builder"
VM_MEMORY = 4096
VM_CPUS = 4

# Build Configuration
AUTO_BUILD_ENABLED = ENV['AUTO_BUILD'] != 'false'
DEFAULT_PYTHON_VERSION = ENV['PYTHON_VERSION'] || "3.12.6"
DEFAULT_BUILD_NUMBER = ENV['BUILD_NUMBER'] || "1"

# Display configuration summary
puts "=" * 70
puts "  IACT CPython Builder"
puts "=" * 70
puts "VM: #{VM_NAME} (#{VM_MEMORY}MB, #{VM_CPUS} CPUs)"
puts "Base: Ubuntu 20.04 LTS"
puts "Auto-build: #{AUTO_BUILD_ENABLED ? 'ENABLED' : 'DISABLED'}"
puts "Python: #{DEFAULT_PYTHON_VERSION}" if AUTO_BUILD_ENABLED
puts "=" * 70
puts ""

def local_cache(box_name)
  cache_dir = File.join(File.expand_path('~/.vagrant.d'), 'cache', 'apt', box_name)
  FileUtils.mkdir_p(cache_dir) unless File.exist?(cache_dir)
  return cache_dir if File.writable?(cache_dir)
rescue
  nil
end

# =============================================================================
# VAGRANT VM CONFIGURATION
# =============================================================================

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = "ubuntu/focal64"
  config.vm.box_check_update = true
  config.vm.box_version = ">= 20210415.0.0"
  config.vm.hostname = VM_HOSTNAME

  # Disable vbguest auto-update if plugin is installed
  if Vagrant.has_plugin?("vagrant-vbguest")
    config.vbguest.auto_update = false
  end

  # SSH configuration
  config.ssh.forward_agent = true
  config.ssh.insert_key = true
  config.ssh.connect_timeout = 120

  # =================================================================
  # NETWORK CONFIGURATION
  # =================================================================

  # Private network with static IP and internal network
  # (prevents DHCP conflicts and works without Guest Additions)
  config.vm.network "private_network",
    ip: "192.168.56.10",
    virtualbox__intnet: true

  # =================================================================
  # SYNCED FOLDERS WITH UTF-8 ENCODING
  # =================================================================

  # APT cache (if available)
  cache_dir = local_cache(config.vm.box)
  if cache_dir
    config.vm.synced_folder cache_dir, "/var/cache/apt/archives/",
      create: true,
      mount_options: ["dmode=755,fmode=644"]
  end

  # CPython directory with UTF-8 encoding
  # This mounts the entire cpython/ directory (including artifacts/, scripts/, etc.)
  config.vm.synced_folder ".", "/vagrant",
    create: true,
    mount_options: [
      "dmode=755,fmode=664",  # 664 for files allows VM to write artifacts
      "iocharset=utf8",
      "ttl=1"
    ]

  # =================================================================
  # VIRTUALBOX PROVIDER CONFIGURATION
  # =================================================================

  config.vm.provider "virtualbox" do |vb|
    vb.name = VM_NAME
    vb.memory = VM_MEMORY
    vb.cpus = VM_CPUS
    vb.gui = false
    vb.linked_clone = true

    # CPU optimizations for compilation workloads
    vb.customize ["modifyvm", :id, "--paravirtprovider", "kvm"]
    vb.customize ["modifyvm", :id, "--cpuexecutioncap", "100"]

		vb.customize ["modifyvm", :id, "--ioapic", "on"]
    vb.customize ["modifyvm", :id, "--vram", "12"]
    vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
    vb.customize ["modifyvm", :id, "--audio", "none"]
    vb.customize ["modifyvm", :id, "--usb", "off"]
    vb.customize ["modifyvm", :id, "--usbehci", "off"]
    vb.customize ["modifyvm", :id, "--paravirtprovider", "kvm"]
    vb.customize ["modifyvm", :id, "--cableconnected1", "on"]
    vb.customize ["modifyvm", :id, "--cpuexecutioncap", "100"]
    vb.customize ["modifyvm", :id, "--rtcuseutc", "on"]
  end


  # Provisioning - delegate everything to bootstrap.sh
  config.vm.provision "shell", inline: <<-SHELL
    set -euo pipefail

    # Validate required files
    if [ ! -f "/vagrant/bootstrap.sh" ]; then
      echo "[ERROR] bootstrap.sh not found"
      exit 1
    fi

    # Set permissions
    chmod +x /vagrant/bootstrap.sh
    find /vagrant/scripts -name "*.sh" -exec chmod +x {} \\; 2>/dev/null || true
    find /vagrant/utils -name "*.sh" -exec chmod +x {} \\; 2>/dev/null || true

    # Execute bootstrap with environment variables
    cd /vagrant
    export AUTO_BUILD=#{AUTO_BUILD_ENABLED}
    export PYTHON_VERSION="#{DEFAULT_PYTHON_VERSION}"
    export BUILD_NUMBER="#{DEFAULT_BUILD_NUMBER}"

    if sudo -E bash bootstrap.sh; then
      echo ""
      echo "[OK] Provisioning completed successfully"
    else
      echo ""
      echo "[ERROR] Provisioning failed"
      echo "Check logs: /vagrant/logs/"
      exit 1
    fi
  SHELL

  config.vm.post_up_message = <<-MESSAGE

  ========================================================================
                    CPython Builder Ready
  ========================================================================

  VM: #{VM_NAME}
  Status: Provisioned
  Auto-build: #{AUTO_BUILD_ENABLED ? "Python #{DEFAULT_PYTHON_VERSION} compiled" : "Disabled"}

  Artifacts: ./artifacts/cpython/
  Logs: ./logs/

  Connect: vagrant ssh
  Build: vagrant ssh -c "cd /vagrant && ./scripts/build_cpython.sh <version>"

  ========================================================================
  MESSAGE
end