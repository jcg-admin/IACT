name: Validate Guides

on:
  pull_request:
    paths:
      - 'docs/guias/**'
      - 'scripts/generate_guides.py'
      - '.github/workflows/validate-guides.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'docs/guias/**'
  workflow_dispatch:

jobs:
  validate-structure:
    name: Validate Guide Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate frontmatter
        run: bash scripts/validation/guides/validate_guides_frontmatter.sh

      - name: Validate guide structure
        run: bash scripts/validation/guides/validate_guides_structure.sh

  check-broken-links:
    name: Check for Broken Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check internal links
        run: |
          echo "Checking for broken internal links..."

          python3 << 'EOF'
          import sys
          from pathlib import Path
          import re

          guides_dir = Path("docs/guias")
          errors = []

          # Get all guide files
          all_files = set()
          for guide_file in guides_dir.rglob("*.md"):
              all_files.add(str(guide_file.relative_to(guides_dir)))

          # Check links in each file
          for guide_file in guides_dir.rglob("*.md"):
              content = guide_file.read_text()

              # Find markdown links: [text](path)
              links = re.findall(r'\[([^\]]+)\]\(([^)]+)\)', content)

              for link_text, link_path in links:
                  # Skip external links
                  if link_path.startswith(('http://', 'https://', '#')):
                      continue

                  # Resolve relative path
                  if link_path.startswith('../'):
                      # Link outside guides/ - skip for now
                      continue

                  # Check if file exists
                  target = guide_file.parent / link_path
                  if not target.exists():
                      errors.append(f"{guide_file}: Broken link to '{link_path}'")

          if errors:
              print("BROKEN LINKS FOUND:")
              for error in errors:
                  print(f"  - {error}")
              print(f"\nTotal: {len(errors)} broken links")
              # Don't fail build yet, just warn
              # sys.exit(1)
          else:
              print("[OK] No broken internal links found")
          EOF

  generate-coverage-report:
    name: Generate Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate coverage report
        run: |
          python scripts/dora_metrics.py --docs-only --format json > docs-coverage.json
          cat docs-coverage.json

      - name: Print summary
        run: |
          python3 << 'EOF'
          import json
          from pathlib import Path

          with open("docs-coverage.json") as f:
              data = json.load(f)

          coverage = data["documentation_metrics"]["coverage"]
          onboarding = data["documentation_metrics"]["onboarding"]

          print("=" * 80)
          print("DOCUMENTATION COVERAGE SUMMARY")
          print("=" * 80)
          print(f"\nTotal Coverage: {coverage['coverage_percent']}%")
          print(f"Guides: {coverage['total_guides_actual']}/{coverage['total_guides_planned']}")
          print(f"\nP0 Coverage: {coverage['by_priority']['P0']['percent']}%")
          print(f"P0 Guides: {coverage['by_priority']['P0']['actual']}/{coverage['by_priority']['P0']['planned']}")
          print(f"\nOnboarding Time: {onboarding['estimated_time_minutes']} min (target: {onboarding['target_time_minutes']} min)")
          print(f"Status: {onboarding['status']}")

          print("\nBy Category:")
          for cat, count in coverage['by_category'].items():
              print(f"  - {cat}: {count} guides")

          print("=" * 80)
          EOF

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-coverage-report
          path: docs-coverage.json

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('docs-coverage.json', 'utf8'));
            const coverage = data.documentation_metrics.coverage;
            const onboarding = data.documentation_metrics.onboarding;

            const comment = `## Documentation Coverage Report

            **Total Coverage:** ${coverage.coverage_percent}% (${coverage.total_guides_actual}/${coverage.total_guides_planned} guides)

            **P0 Coverage:** ${coverage.by_priority.P0.percent}% (${coverage.by_priority.P0.actual}/${coverage.by_priority.P0.planned} guides)

            **Onboarding Time:** ${onboarding.estimated_time_minutes} min (target: ${onboarding.target_time_minutes} min)
            **Status:** ${onboarding.status}

            ### By Category
            ${Object.entries(coverage.by_category).map(([cat, count]) => `- ${cat}: ${count} guides`).join('\n')}

            ---
            *Generated by validate-guides workflow*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run quality checks
        run: bash scripts/validation/guides/check_guides_quality.sh

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [validate-structure, check-broken-links, generate-coverage-report, quality-checks]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Validation Results:"
          echo "  - Structure: ${{ needs.validate-structure.result }}"
          echo "  - Links: ${{ needs.check-broken-links.result }}"
          echo "  - Coverage: ${{ needs.generate-coverage-report.result }}"
          echo "  - Quality: ${{ needs.quality-checks.result }}"

          if [[ "${{ needs.validate-structure.result }}" == "failure" ]]; then
            echo "ERROR: Structure validation failed"
            exit 1
          fi
