name: Lint Requirements Frontmatter

on:
  pull_request:
    paths:
      - 'implementacion/**/requisitos/**/*.md'
  push:
    paths:
      - 'implementacion/**/requisitos/**/*.md'

jobs:
  lint-frontmatter:
    name: Validate Requirements Frontmatter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate frontmatter
        run: |
          python3 << 'EOF'
          import os
          import re
          import sys

          print("Validating requirements frontmatter...")
          print("=" * 80)

          errors = []
          warnings = []
          valid_count = 0

          required_fields = ['id', 'tipo', 'titulo', 'dominio', 'owner', 'prioridad', 'estado', 'fecha_creacion']

          for root, dirs, files in os.walk('implementacion'):
              if 'requisitos' not in root:
                  continue

              for file in files:
                  if not file.endswith('.md') or file.startswith('_'):
                      continue

                  filepath = os.path.join(root, file)

                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()

                  # Check frontmatter exists
                  match = re.match(r'^---\s*
(.*?)
---\s*
', content, re.DOTALL)
                  if not match:
                      errors.append(f"ERROR: {filepath}: No frontmatter found")
                      continue

                  yaml_content = match.group(1)
                  fields = {}

                  # Simple YAML parser
                  for line in yaml_content.split('
'):
                      if ':' in line and not line.startswith(' '):
                          key, value = line.split(':', 1)
                          fields[key.strip()] = value.strip()

                  # Check required fields
                  missing = [f for f in required_fields if f not in fields or not fields[f]]

                  if missing:
                      errors.append(f"ERROR: {filepath}: Missing required fields: {', '.join(missing)}")
                  else:
                      valid_count += 1

                  # Check ID format
                  if 'id' in fields:
                      req_id = fields['id']
                      if not re.match(r'^(N|RN|RS|RF|RNF)-\d{3}$', req_id):
                          warnings.append(f"WARNING: {filepath}: ID '{req_id}' does not follow standard format (N|RN|RS|RF|RNF)-XXX")

          print(f"
Validation Results:")
          print(f"  Valid files: {valid_count}")
          print(f"  Errors: {len(errors)}")
          print(f"  Warnings: {len(warnings)}")
          print("")

          if errors:
              print("ERRORS:")
              for error in errors:
                  print(f"  {error}")
              print("")

          if warnings:
              print("WARNINGS:")
              for warning in warnings:
                  print(f"  {warning}")
              print("")

          if errors:
              print("VALIDATION FAILED")
              sys.exit(1)
          else:
              print("VALIDATION PASSED")
              sys.exit(0)
          EOF

      - name: Summary
        if: always()
        run: |
          echo "## Frontmatter Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All requirements must have valid YAML frontmatter with required fields:" >> $GITHUB_STEP_SUMMARY
          echo "- id, tipo, titulo, dominio, owner, prioridad, estado, fecha_creacion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See templates in docs/plantillas/" >> $GITHUB_STEP_SUMMARY
