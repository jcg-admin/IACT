name: Validate Requirements Traceability

on:
  pull_request:
    paths:
      - 'implementacion/**/requisitos/**/*.md'
  push:
    branches:
      - main
      - develop
    paths:
      - 'implementacion/**/requisitos/**/*.md'
  workflow_dispatch:

jobs:
  validate-traceability:
    name: Validate Traceability Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install validation dependencies
        run: pip install pyyaml

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate traceability
        run: |
          python3 << 'EOF'
          import os
          import re
          import sys
          from typing import Iterable, List

          import yaml

          FRONT_MATTER_PATTERN = re.compile(r"^---\s*\n(.*?)\n---\s*", re.DOTALL)

          def ensure_list(value: Iterable | str | None) -> List[str]:
              if value is None:
                  return []
              if isinstance(value, str):
                  return [value.strip()] if value.strip() else []
              return [str(item).strip() for item in value if str(item).strip()]

          print("Validating requirements traceability...")
          print("=" * 80)

          all_req_ids = set()
          requirements = {}
          broken_links = []
          orphaned_requirements = []
          invalid_front_matter = []

          # First pass: collect all requirement IDs
          for root, _, files in os.walk('implementacion'):
              if 'requisitos' not in root:
                  continue

              for file in files:
                  if not file.endswith('.md') or file.startswith('_'):
                      continue

                  filepath = os.path.join(root, file)

                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()

                  match = FRONT_MATTER_PATTERN.match(content)
                  if not match:
                      continue

                  try:
                      metadata = yaml.safe_load(match.group(1)) or {}
                  except yaml.YAMLError as exc:
                      invalid_front_matter.append({'path': filepath, 'error': str(exc)})
                      continue

                  req_id = metadata.get('id')
                  if not req_id:
                      continue

                  all_req_ids.add(req_id)
                  requirements[req_id] = {
                      'path': filepath,
                      'tipo': metadata.get('tipo', ''),
                      'upward': ensure_list(metadata.get('trazabilidad_upward')),
                      'downward': ensure_list(metadata.get('trazabilidad_downward')),
                  }

          print(f"Found {len(all_req_ids)} requirements")

          # Second pass: validate traceability links
          for req_id, data in requirements.items():
              for parent_id in data['upward']:
                  if parent_id not in all_req_ids:
                      broken_links.append({
                          'req_id': req_id,
                          'path': data['path'],
                          'missing': parent_id,
                          'direction': 'upward',
                      })

              for child_id in data['downward']:
                  if child_id not in all_req_ids:
                      broken_links.append({
                          'req_id': req_id,
                          'path': data['path'],
                          'missing': child_id,
                          'direction': 'downward',
                      })

              if data['tipo'] not in ['necesidad'] and not data['upward']:
                  orphaned_requirements.append({
                      'req_id': req_id,
                      'path': data['path'],
                      'tipo': data['tipo'],
                  })

          print("")
          print("Results:")
          print(f"  Broken links: {len(broken_links)}")
          print(f"  Orphaned requirements: {len(orphaned_requirements)}")
          print(f"  Invalid front matter: {len(invalid_front_matter)}")

          if broken_links:
              print("")
              print("BROKEN LINKS:")
              for link in broken_links:
                  print(f"  {link['req_id']} ({link['path']})")
                  print(f"    -> References non-existent {link['direction']} link: {link['missing']}")

          if orphaned_requirements:
              print("")
              print("ORPHANED REQUIREMENTS (no upward traceability):")
              for req in orphaned_requirements:
                  print(f"  {req['req_id']} ({req['tipo']}) - {req['path']}")

          if invalid_front_matter:
              print("")
              print("INVALID FRONT MATTER:")
              for item in invalid_front_matter:
                  print(f"  {item['path']}")
                  print(f"    -> {item['error']}")

          print("")
          if broken_links or invalid_front_matter:
              print("VALIDATION FAILED: Broken traceability links or invalid front matter found")
              sys.exit(1)

          print("VALIDATION PASSED: All traceability links are valid")
          if orphaned_requirements:
              print(f"WARNING: {len(orphaned_requirements)} orphaned requirements (informational)")
          sys.exit(0)
          EOF

      - name: Generate traceability report
        if: always()
        run: |
          echo "## Traceability Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Validates that all trazabilidad_upward and trazabilidad_downward references" >> $GITHUB_STEP_SUMMARY
          echo "point to existing requirements." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ISO/IEC/IEEE 29148:2018 - Clause 5.2.8: Traceability" >> $GITHUB_STEP_SUMMARY
