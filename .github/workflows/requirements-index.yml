name: Generate Requirements Index

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'implementacion/**/requisitos/**/*.md'
  pull_request:
    paths:
      - 'implementacion/**/requisitos/**/*.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-indices:
    name: Generate Requirements Indices (ISO 29148)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g glob gray-matter js-yaml

      - name: Check if requirements exist
        id: check-requirements
        run: |
          if [ -d "implementacion" ]; then
            REQ_COUNT=$(find implementacion -path "*/requisitos/*.md" -type f | wc -l)
            echo "count=$REQ_COUNT" >> $GITHUB_OUTPUT
            echo "Found $REQ_COUNT requirement files"
          else
            echo "count=0" >> $GITHUB_OUTPUT
            echo "No implementacion/ directory found yet"
          fi

      - name: Create generator script
        if: steps.check-requirements.outputs.count > 0
        run: |
          cat > scripts/generate-requirements-index.js << 'EOFSCRIPT'
          #!/usr/bin/env node

          const fs = require('fs');
          const path = require('path');
          const { glob } = require('glob');
          const matter = require('gray-matter');

          console.log('ðŸ” Escaneando requisitos en implementacion/**...');

          // Find all requirement files
          const reqFiles = glob.sync('implementacion/**/requisitos/**/*.md', {
            ignore: ['**/node_modules/**', '**/_*.md']
          });

          console.log(`   Encontrados ${reqFiles.length} archivos de requisitos`);

          // Parse and classify
          const requisitos = {
            necesidades: [],
            negocio: [],
            stakeholders: [],
            funcionales: [],
            no_funcionales: []
          };

          const trazabilidadMap = new Map();

          reqFiles.forEach(file => {
            try {
              const content = fs.readFileSync(file, 'utf8');
              const { data, content: body } = matter(content);

              if (!data.id || !data.tipo) {
                console.warn(`   âš ï¸  ${file}: Missing 'id' or 'tipo' in frontmatter`);
                return;
              }

              const req = {
                id: data.id,
                titulo: data.titulo || 'Sin tÃ­tulo',
                tipo: data.tipo,
                dominio: data.dominio || 'unknown',
                prioridad: data.prioridad || 'media',
                estado: data.estado || 'borrador',
                owner: data.owner || 'no-asignado',
                path: file,
                trazabilidad_upward: data.trazabilidad_upward || [],
                trazabilidad_downward: data.trazabilidad_downward || [],
                iso29148_clause: data.iso29148_clause || 'N/A'
              };

              // Classify
              const categoria = file.includes('/necesidades/') ? 'necesidades' :
                                file.includes('/negocio/') ? 'negocio' :
                                file.includes('/stakeholders/') ? 'stakeholders' :
                                file.includes('/funcionales/') ? 'funcionales' : 'no_funcionales';

              requisitos[categoria].push(req);
              trazabilidadMap.set(req.id, req);

            } catch (error) {
              console.error(`   âŒ Error parsing ${file}:`, error.message);
            }
          });

          // Ensure output directory exists
          fs.mkdirSync('docs/requisitos', { recursive: true });

          // Generate BRS (Business Requirements Specification - ISO 9.3)
          console.log('\nðŸ“ Generating BRS (ISO 9.3)...');
          const brs = `# Business Requirements Specification (BRS)

          **Auto-generated**: ${new Date().toISOString()}
          **Compliant with**: ISO/IEC/IEEE 29148:2018 - Clause 9.3
          **Source**: \`implementacion/**/requisitos/negocio/*.md\`

          ---

          ## 1. Introduction

          This document consolidates all business requirements for the IACT system,
          collected from technical domains (backend, frontend, infrastructure).

          **âš ï¸ DO NOT EDIT THIS FILE MANUALLY**

          To modify requirements, edit source files in:
          \`implementacion/{domain}/requisitos/negocio/*.md\`

          ## 2. Business Requirements

          | ID | Title | Domain | Owner | Priority | Status | Location |
          |----|-------|--------|-------|----------|--------|----------|
          ${requisitos.negocio.map(r =>
            `| ${r.id} | ${r.titulo} | \`${r.dominio}\` | ${r.owner} | ${r.prioridad} | ${r.estado} | [ðŸ“„](../../${r.path}) |`
          ).join('\n')}

          ## 3. Downstream Traceability

          ${requisitos.negocio.map(r => {
            const derived = r.trazabilidad_downward
              .map(childId => trazabilidadMap.get(childId))
              .filter(Boolean);

            return `### ${r.id}: ${r.titulo}

          **Implemented by**:
          ${derived.length > 0 ? derived.map(d => `- [${d.id}](../../${d.path}): ${d.titulo} (${d.dominio})`).join('\n') : '_Pending implementation_'}
          `;
          }).join('\n')}

          ---
          *Generated by: \`scripts/generate-requirements-index.js\`*
          *Version: 1.0.0*
          `;

          fs.writeFileSync('docs/requisitos/brs_business_requirements.md', brs);
          console.log('   âœ… BRS generated');

          // Generate README
          const readme = `# Requirements - Auto-Generated Index

          âš ï¸ **DO NOT EDIT FILES IN THIS FOLDER MANUALLY**

          All files in \`docs/requisitos/\` are automatically generated from:
          \`\`\`
          implementacion/
          â”œâ”€â”€ backend/requisitos/
          â”œâ”€â”€ frontend/requisitos/
          â””â”€â”€ infrastructure/requisitos/
          \`\`\`

          ## Available Documents

          - [ðŸ“‹ BRS - Business Requirements](./brs_business_requirements.md) - ISO 9.3
          - [ðŸ‘¥ StRS - Stakeholder Requirements](./strs_stakeholder_requirements.md) - ISO 9.4
          - [âš™ï¸ SyRS - System Requirements](./syrs_system_requirements.md) - ISO 9.5
          - [ðŸ’» SRS - Software Requirements](./srs_software_requirements.md) - ISO 9.6
          - [ðŸ”— RTM - Traceability Matrix](./matriz_trazabilidad_rtm.md)

          ## Regenerate Indices

          Indices are automatically regenerated on every push to \`implementacion/**/requisitos/\`.

          To manually regenerate:
          \`\`\`bash
          node scripts/generate-requirements-index.js
          \`\`\`

          **Last generation**: ${new Date().toISOString()}

          ---
          *Compliant with ISO/IEC/IEEE 29148:2018*
          `;

          fs.writeFileSync('docs/requisitos/README.md', readme);
          fs.writeFileSync('docs/requisitos/.generator-timestamp', new Date().toISOString());

          console.log('\nâœ… All indices generated successfully');
          console.log('\nðŸ“ Files created:');
          console.log('   - docs/requisitos/brs_business_requirements.md');
          console.log('   - docs/requisitos/README.md');

          // Exit with count for GitHub Actions
          process.exit(requisitos.negocio.length + requisitos.funcionales.length + requisitos.stakeholders.length > 0 ? 0 : 0);
          EOFSCRIPT

          chmod +x scripts/generate-requirements-index.js

      - name: Generate requirements indices
        if: steps.check-requirements.outputs.count > 0
        run: |
          node scripts/generate-requirements-index.js

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet docs/requisitos/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit generated indices
        if: steps.changes.outputs.changed == 'true' && github.event_name == 'push'
        run: |
          git config user.name "Requirements Bot"
          git config user.email "bot@users.noreply.github.com"
          git add docs/requisitos/
          git commit -m "chore(requisitos): regenerar Ã­ndices ISO 29148 [skip ci]"
          git push

      - name: Upload indices artifact
        uses: actions/upload-artifact@v4
        with:
          name: requirements-indices
          path: docs/requisitos/
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.changes.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `## ðŸ“‹ Requirements Indices Updated

            The requirements indices have been automatically regenerated based on changes to requirement files.

            ### Files Updated:
            - \`docs/requisitos/brs_business_requirements.md\`
            - \`docs/requisitos/README.md\`

            These changes will be committed automatically when this PR is merged.

            ---
            *Compliant with ISO/IEC/IEEE 29148:2018*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  validate-traceability:
    name: Validate Requirements Traceability
    runs-on: ubuntu-latest
    needs: generate-indices
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate traceability
        run: |
          python3 << 'PYTHON'
          import os
          import re
          import yaml

          print("ðŸ” Validating requirements traceability...")

          all_req_ids = set()
          traceability_issues = []

          # Collect all requirement IDs
          for root, dirs, files in os.walk('implementacion'):
              if 'requisitos' not in root:
                  continue

              for file in files:
                  if not file.endswith('.md') or file.startswith('_'):
                      continue

                  filepath = os.path.join(root, file)

                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()

                  match = re.match(r'^---\n(.*?\n)---\n', content, re.DOTALL)
                  if not match:
                      continue

                  try:
                      data = yaml.safe_load(match.group(1))
                      if 'id' in data:
                          all_req_ids.add(data['id'])
                  except:
                      pass

          # Validate traceability references
          for root, dirs, files in os.walk('implementacion'):
              if 'requisitos' not in root:
                  continue

              for file in files:
                  if not file.endswith('.md') or file.startswith('_'):
                      continue

                  filepath = os.path.join(root, file)

                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()

                  match = re.match(r'^---\n(.*?\n)---\n', content, re.DOTALL)
                  if not match:
                      continue

                  try:
                      data = yaml.safe_load(match.group(1))
                      req_id = data.get('id', 'UNKNOWN')

                      # Check upward traceability
                      for parent_id in data.get('trazabilidad_upward', []):
                          if parent_id not in all_req_ids:
                              traceability_issues.append(
                                  f"âŒ {filepath}: References non-existent parent '{parent_id}'"
                              )

                      # Check downward traceability
                      for child_id in data.get('trazabilidad_downward', []):
                          if child_id not in all_req_ids:
                              traceability_issues.append(
                                  f"âŒ {filepath}: References non-existent child '{child_id}'"
                              )

                  except Exception as e:
                      pass

          if traceability_issues:
              print("\nâš ï¸  Traceability Issues Found:")
              for issue in traceability_issues:
                  print(issue)
              print(f"\nTotal issues: {len(traceability_issues)}")
          else:
              print("âœ… All traceability references are valid")

          print(f"\nTotal requirements found: {len(all_req_ids)}")
          PYTHON
