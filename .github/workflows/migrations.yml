name: Database Migrations

on:
  pull_request:
    paths:
      - 'api/**/migrations/**'
      - 'api/**/models.py'
  push:
    branches: [ main, develop ]
    paths:
      - 'api/**/migrations/**'
      - 'api/**/models.py'

jobs:
  detect-migrations:
    name: Detect Migration Changes
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect new migrations
        id: detect
        run: |
          echo "Detecting new migration files..."

          NEW_MIGRATIONS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "migrations/.*\.py$" | grep -v "__init__.py" || echo "")

          if [ -z "$NEW_MIGRATIONS" ]; then
            echo "No new migrations detected"
            echo "has_migrations=false" >> $GITHUB_OUTPUT
          else
            echo "New migrations detected:"
            echo "$NEW_MIGRATIONS"
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "$NEW_MIGRATIONS" > new_migrations.txt
          fi

      - name: Upload migration list
        if: steps.detect.outputs.has_migrations == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: new-migrations
          path: new_migrations.txt

    outputs:
      has_migrations: ${{ steps.detect.outputs.has_migrations }}

  validate-migrations:
    name: Validate Migrations
    runs-on: ubuntu-latest
    needs: detect-migrations
    if: needs.detect-migrations.outputs.has_migrations == 'true'

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: test_iact
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: test_iact
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r api/requirements.txt
          pip install django-migration-linter

      - name: Check migration syntax
        run: |
          cd api/callcentersite

          echo "Checking migration files for common issues..."

          python manage.py makemigrations --check --dry-run || {
            echo "❌ Unapplied model changes detected. Run makemigrations."
            exit 1
          }

          echo "✅ No unapplied model changes"

      - name: Lint migrations
        run: |
          cd api/callcentersite

          echo "Linting migrations for potential issues..."

          python manage.py lintmigrations --warnings-as-errors || {
            echo "⚠️  Migration linting found issues"
          }

      - name: Test migrations on MySQL
        env:
          DB_ENGINE: django.db.backends.mysql
          DB_NAME: test_iact
          DB_USER: root
          DB_PASSWORD: testpass
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
        run: |
          cd api/callcentersite

          echo "Testing migrations on MySQL..."

          # Run migrations forward
          python manage.py migrate --no-input

          # Show applied migrations
          python manage.py showmigrations

          echo "✅ MySQL migrations successful"

      - name: Test migrations on PostgreSQL
        env:
          DB_ENGINE: django.db.backends.postgresql
          DB_NAME: test_iact
          DB_USER: postgres
          DB_PASSWORD: testpass
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
        run: |
          cd api/callcentersite

          echo "Testing migrations on PostgreSQL..."

          # Run migrations forward
          python manage.py migrate --no-input

          # Show applied migrations
          python manage.py showmigrations

          echo "✅ PostgreSQL migrations successful"

      - name: Test migration reversibility
        env:
          DB_ENGINE: django.db.backends.mysql
          DB_NAME: test_iact
          DB_USER: root
          DB_PASSWORD: testpass
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
        run: |
          cd api/callcentersite

          echo "Testing migration reversibility..."

          # Get last migration
          LAST_MIGRATION=$(python manage.py showmigrations --plan | grep "\[X\]" | tail -1 | awk '{print $2}')

          if [ -n "$LAST_MIGRATION" ]; then
            echo "Attempting to reverse: $LAST_MIGRATION"

            # Try to reverse last migration
            python manage.py migrate $(echo $LAST_MIGRATION | cut -d. -f1) $(echo $LAST_MIGRATION | cut -d_ -f1-2) || {
              echo "⚠️  Migration not reversible: $LAST_MIGRATION"
              echo "This is acceptable for data migrations, but document it"
            }

            # Re-apply migration
            python manage.py migrate --no-input
          else
            echo "No migrations to reverse"
          fi

  check-migration-safety:
    name: Check Migration Safety
    runs-on: ubuntu-latest
    needs: detect-migrations
    if: needs.detect-migrations.outputs.has_migrations == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Download migration list
        uses: actions/download-artifact@v4
        with:
          name: new-migrations

      - name: Check for dangerous operations
        run: |
          echo "Checking for dangerous migration operations..."

          DANGEROUS=false

          while read migration_file; do
            echo "Checking: $migration_file"

            # Check for DROP COLUMN (data loss)
            if grep -q "RemoveField\|AlterField.*null=False" "$migration_file"; then
              echo "⚠️  WARNING: $migration_file contains potentially destructive operations"
              DANGEROUS=true
            fi

            # Check for DROP TABLE (data loss)
            if grep -q "DeleteModel" "$migration_file"; then
              echo "⚠️  WARNING: $migration_file deletes models (tables)"
              DANGEROUS=true
            fi

            # Check for RENAME operations (risky)
            if grep -q "RenameField\|RenameModel" "$migration_file"; then
              echo "⚠️  WARNING: $migration_file renames fields/models"
              DANGEROUS=true
            fi

            # Check for NOT NULL without default (will fail on existing data)
            if grep -q "null=False" "$migration_file" && ! grep -q "default=" "$migration_file"; then
              echo "⚠️  WARNING: $migration_file adds NOT NULL field without default"
              DANGEROUS=true
            fi

          done < new_migrations.txt

          if [ "$DANGEROUS" == "true" ]; then
            echo ""
            echo "❌ DANGEROUS MIGRATIONS DETECTED"
            echo ""
            echo "Review these migrations carefully:"
            echo "1. Ensure data migration is in place if needed"
            echo "2. Consider multi-step deployment for destructive changes"
            echo "3. Document rollback procedure"
            echo "4. Test on staging first"
            echo ""
            echo "If you're sure, add '# DANGEROUS_MIGRATION_APPROVED' comment to migration file"

            # Check if approved
            if ! grep -q "# DANGEROUS_MIGRATION_APPROVED" "$migration_file"; then
              exit 1
            else
              echo "✅ Dangerous migration approved by developer"
            fi
          else
            echo "✅ No dangerous operations detected"
          fi

  generate-migration-report:
    name: Generate Migration Report
    runs-on: ubuntu-latest
    needs: [detect-migrations, validate-migrations, check-migration-safety]
    if: always() && needs.detect-migrations.outputs.has_migrations == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Download migration list
        uses: actions/download-artifact@v4
        with:
          name: new-migrations

      - name: Generate report
        run: |
          cat << 'EOF' > migration-report.md
          # Database Migration Report

          **Date**: $(date +"%Y-%m-%d %H:%M:%S")
          **Branch**: ${{ github.ref }}
          **Commit**: ${{ github.sha }}

          ## New Migrations

          EOF

          while read migration_file; do
            echo "- \`$migration_file\`" >> migration-report.md
          done < new_migrations.txt

          cat << 'EOF' >> migration-report.md

          ## Validation Results

          - MySQL: ${{ needs.validate-migrations.result }}
          - PostgreSQL: ${{ needs.validate-migrations.result }}
          - Safety Check: ${{ needs.check-migration-safety.result }}

          ## Deployment Instructions

          ### Staging Deployment

          ```bash
          cd api/callcentersite
          python manage.py migrate --no-input
          ```

          ### Production Deployment

          1. Create database backup
          2. Run migrations during low-traffic window
          3. Monitor for errors
          4. Have rollback plan ready

          ```bash
          # Backup first
          mysqldump -u root -p iact_production > backup_$(date +%Y%m%d_%H%M%S).sql

          # Run migrations
          python manage.py migrate --no-input

          # Verify
          python manage.py showmigrations
          ```

          ---

          Generated by Database Migrations workflow
          EOF

          cat migration-report.md

      - name: Upload migration report
        uses: actions/upload-artifact@v4
        with:
          name: migration-report
          path: migration-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('migration-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  summary:
    name: Migration CI Summary
    runs-on: ubuntu-latest
    needs: [detect-migrations, validate-migrations, check-migration-safety]
    if: always()

    steps:
      - name: Check Status
        run: |
          HAS_MIGRATIONS="${{ needs.detect-migrations.outputs.has_migrations }}"

          if [ "$HAS_MIGRATIONS" == "false" ]; then
            echo "No migrations detected, skipping validation"
            exit 0
          fi

          echo "Migration CI Results:"
          echo "  Validation: ${{ needs.validate-migrations.result }}"
          echo "  Safety Check: ${{ needs.check-migration-safety.result }}"

          if [ "${{ needs.validate-migrations.result }}" != "success" ] || \
             [ "${{ needs.check-migration-safety.result }}" != "success" ]; then
            echo "❌ Migration CI FAILED"
            exit 1
          fi

          echo "✅ Migration CI PASSED"
