name: Infrastructure CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'infrastructure/**'
      - 'scripts/**'
      - '.github/workflows/infrastructure-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'infrastructure/**'
      - 'scripts/**'

jobs:
  workspace-vpn-proxy:
    name: Workspace VPN/Proxy Agent
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: infrastructure/workspace/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Node dependencies
        working-directory: infrastructure/workspace
        run: npm install

      - name: Install Python dependencies
        working-directory: infrastructure/workspace
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint workspace (Python + Node)
        working-directory: infrastructure/workspace
        run: npm run lint

      - name: Type check workspace
        working-directory: infrastructure/workspace
        run: npm run typecheck

      - name: Run workspace tests
        working-directory: infrastructure/workspace
        run: npm test

  validate-shell-scripts:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck on all scripts
        run: |
          echo "Running shellcheck on shell scripts..."

          find scripts/ -name "*.sh" -type f | while read script; do
            echo "Checking: $script"
            shellcheck -x "$script" || {
              echo "[FAIL] Shellcheck failed for: $script"
              exit 1
            }
          done

          echo "[PASS] All shell scripts passed shellcheck"

      - name: Check script permissions
        run: |
          echo "Checking script permissions..."

          find scripts/ -name "*.sh" -type f | while read script; do
            if [ ! -x "$script" ]; then
              echo "[WARNING]  WARNING: $script is not executable"
              echo "  Run: chmod +x $script"
            fi
          done

  test-validation-scripts:
    name: Test Validation Scripts
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: test_iact
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r api/requirements.txt

      - name: Test validate_critical_restrictions.sh
        run: |
          if [ -f scripts/validate_critical_restrictions.sh ]; then
            echo "Testing validate_critical_restrictions.sh..."
            bash scripts/validate_critical_restrictions.sh
          else
            echo "[WARNING]  WARNING: validate_critical_restrictions.sh not found"
          fi

      - name: Test validate_security_config.sh
        run: |
          if [ -f scripts/validate_security_config.sh ]; then
            echo "Testing validate_security_config.sh..."
            bash scripts/validate_security_config.sh
          else
            echo "[WARNING]  WARNING: validate_security_config.sh not found"
          fi

      - name: Test validate_database_router.sh
        run: |
          if [ -f scripts/validate_database_router.sh ]; then
            echo "Testing validate_database_router.sh..."
            bash scripts/validate_database_router.sh
          else
            echo "[WARNING]  WARNING: validate_database_router.sh not found"
          fi

  validate-terraform:
    name: Validate Terraform (if applicable)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for Terraform files
        id: check_tf
        run: |
          if [ -d infrastructure/terraform ]; then
            echo "has_terraform=true" >> $GITHUB_OUTPUT
          else
            echo "has_terraform=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Terraform
        if: steps.check_tf.outputs.has_terraform == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform fmt
        if: steps.check_tf.outputs.has_terraform == 'true'
        run: |
          cd infrastructure/terraform
          terraform fmt -check -recursive

      - name: Terraform init
        if: steps.check_tf.outputs.has_terraform == 'true'
        run: |
          cd infrastructure/terraform
          terraform init -backend=false

      - name: Terraform validate
        if: steps.check_tf.outputs.has_terraform == 'true'
        run: |
          cd infrastructure/terraform
          terraform validate

      - name: Run tfsec
        if: steps.check_tf.outputs.has_terraform == 'true'
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: infraestructura/terraform
          soft_fail: true

  validate-docker:
    name: Validate Docker Configuration
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for Dockerfiles
        id: check_docker
        run: |
          if find . -name "Dockerfile" -o -name "docker-compose.yml" | grep -q .; then
            echo "has_docker=true" >> $GITHUB_OUTPUT
          else
            echo "has_docker=false" >> $GITHUB_OUTPUT
          fi

      - name: Run hadolint on Dockerfiles
        if: steps.check_docker.outputs.has_docker == 'true'
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "Dockerfile"
          recursive: true

      - name: Validate docker-compose
        if: steps.check_docker.outputs.has_docker == 'true'
        run: |
          if [ -f docker-compose.yml ]; then
            docker-compose config -q
          fi

  validate-configurations:
    name: Validate Configuration Files
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate YAML files
        run: |
          echo "Validating YAML files..."

          find . -name "*.yml" -o -name "*.yaml" | while read yaml_file; do
            echo "Checking: $yaml_file"
            python -c "import yaml; yaml.safe_load(open('$yaml_file'))" || {
              echo "[FAIL] Invalid YAML: $yaml_file"
              exit 1
            }
          done

          echo "[PASS] All YAML files are valid"

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."

          find . -name "*.json" | while read json_file; do
            echo "Checking: $json_file"
            python -c "import json; json.load(open('$json_file'))" || {
              echo "[FAIL] Invalid JSON: $json_file"
              exit 1
            }
          done

          echo "[PASS] All JSON files are valid"

      - name: Check for secrets in code
        run: |
          echo "Scanning for hardcoded secrets..."

          # Simple pattern matching for common secrets
          if grep -r -E "(password|secret|api_key|token).*=.*['\"].*['\"]" api/ scripts/ | grep -v "test" | grep -v ".pyc"; then
            echo "[WARNING]  WARNING: Potential hardcoded secrets found"
            echo "Review the matches above and ensure they are not real secrets"
          else
            echo "[PASS] No obvious hardcoded secrets found"
          fi

  test-health-check:
    name: Test Health Check Scripts
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: test_iact
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r api/requirements.txt

      - name: Start Django test server
        env:
          DB_ENGINE: django.db.backends.mysql
          DB_NAME: test_iact
          DB_USER: root
          DB_PASSWORD: testpass
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
        run: |
          cd api/callcentersite
          python manage.py migrate --no-input
          python manage.py runserver 8000 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

          # Wait for server to start
          sleep 5

      - name: Test health check endpoint
        run: |
          echo "Testing health check endpoint..."

          curl -f http://localhost:8000/api/health || {
            echo "[FAIL] Health check endpoint failed"
            exit 1
          }

          echo "[PASS] Health check endpoint working"

      - name: Stop server
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill $SERVER_PID || true
          fi

  summary:
    name: Infrastructure CI Summary
    runs-on: ubuntu-latest
    needs: [validate-shell-scripts, test-validation-scripts, validate-terraform, validate-docker, validate-configurations, test-health-check]
    if: always()

    steps:
      - name: Check Status
        run: |
          echo "Infrastructure CI Results:"
          echo "  Shell Scripts: ${{ needs.validate-shell-scripts.result }}"
          echo "  Validation Scripts: ${{ needs.test-validation-scripts.result }}"
          echo "  Terraform: ${{ needs.validate-terraform.result }}"
          echo "  Docker: ${{ needs.validate-docker.result }}"
          echo "  Configurations: ${{ needs.validate-configurations.result }}"
          echo "  Health Check: ${{ needs.test-health-check.result }}"

          if [ "${{ needs.validate-shell-scripts.result }}" != "success" ] || \
             [ "${{ needs.test-validation-scripts.result }}" != "success" ] || \
             [ "${{ needs.validate-terraform.result }}" != "success" ] || \
             [ "${{ needs.validate-docker.result }}" != "success" ] || \
             [ "${{ needs.validate-configurations.result }}" != "success" ] || \
             [ "${{ needs.test-health-check.result }}" != "success" ]; then
            echo "[FAIL] Infrastructure CI FAILED"
            exit 1
          fi

          echo "[PASS] Infrastructure CI PASSED"
