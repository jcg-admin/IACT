name: Meta-Architecture Analysis

on:
  pull_request:
    branches:
      - main
      - master
      - develop
  push:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  architecture-analysis:
    name: Run Architecture Analysis Pipeline
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Meta-Development Agent Tests
        run: |
          pytest tests/ai/agents/meta/ -v --tb=short

      - name: Run Architecture Analysis on Changed Files
        id: analysis
        run: |
          python scripts/ci/run_architecture_analysis.py
        continue-on-error: true

      - name: Post Analysis Results as Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read analysis results if available
            let comment = '## ðŸ—ï¸ Architecture Analysis Results\n\n';

            try {
              const results = fs.readFileSync('architecture_analysis_results.md', 'utf8');
              comment += results;
            } catch (error) {
              comment += 'âœ… No architecture issues detected or analysis could not be completed.\n';
            }

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload Analysis Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: architecture-analysis-results
          path: |
            architecture_analysis_results.md
            architecture_analysis_results.json
          retention-days: 30

      - name: Check for Critical Issues
        run: |
          python scripts/ci/check_critical_issues.py
        continue-on-error: false

  code-quality-gate:
    name: Code Quality Gate
    runs-on: ubuntu-latest
    needs: architecture-analysis
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Evaluate Code Quality Score
        id: quality
        run: |
          python scripts/ci/evaluate_quality_score.py
          echo "score=$(cat quality_score.txt)" >> $GITHUB_OUTPUT

      - name: Quality Gate Check
        run: |
          SCORE=$(cat quality_score.txt)
          THRESHOLD=0.7

          if (( $(echo "$SCORE < $THRESHOLD" | bc -l) )); then
            echo "âŒ Quality score $SCORE is below threshold $THRESHOLD"
            echo "Please address the architecture recommendations before merging."
            exit 1
          else
            echo "âœ… Quality score $SCORE meets threshold $THRESHOLD"
          fi
