@startuml STATE-CALL-001-estados-llamada
!theme plain
title Máquina de Estados - Llamada Telefónica
caption Ciclo de vida completo de una llamada en el sistema
footer Proyecto IACT | Generado: 2025-11-17 | ADR-GOB-004

[*] --> ENTRANTE : Llamada recibida\ndesde Twilio

state ENTRANTE {
  ENTRANTE : Estado inicial
  ENTRANTE : Llamada sonando
  ENTRANTE : Esperando asignación de agente
  --
  ENTRANTE : fecha_inicio = NOW()
  ENTRANTE : estado_id = ENTRANTE
}

state EN_CURSO {
  EN_CURSO : Llamada activa
  EN_CURSO : Conversación en progreso
  EN_CURSO : Agente y cliente conectados
  --
  EN_CURSO : agente_id asignado
  EN_CURSO : grabacion_activa = true
}

state EN_ESPERA {
  EN_ESPERA : Llamada en hold
  EN_ESPERA : Cliente esperando
  EN_ESPERA : Agente puede atender otra llamada
  --
  EN_ESPERA : Música en espera
  EN_ESPERA : metadata.hold_time acumulado
}

state TRANSFERIDA {
  TRANSFERIDA : Llamada transferida
  TRANSFERIDA : A otro agente/departamento
  TRANSFERIDA : En proceso de handoff
  --
  TRANSFERIDA : metadata.transfer_from
  TRANSFERIDA : metadata.transfer_to
  TRANSFERIDA : metadata.transfer_reason
}

state FINALIZADA {
  FINALIZADA : Llamada completada exitosamente
  FINALIZADA : Cliente atendido
  FINALIZADA : Estado final
  --
  FINALIZADA : fecha_fin = NOW()
  FINALIZADA : duracion calculada
  FINALIZADA : es_final = true
}

state PERDIDA {
  PERDIDA : Llamada no atendida
  PERDIDA : Cliente colgó antes de atención
  PERDIDA : Estado final
  --
  PERDIDA : fecha_fin = NOW()
  PERDIDA : es_final = true
  PERDIDA : metadata.abandon_reason
}

' =====================================================
' TRANSICIONES NORMALES
' =====================================================

ENTRANTE --> EN_CURSO : [agente_responde]\nAgente contesta llamada\n/ asignar agente\n/ iniciar grabación

ENTRANTE --> PERDIDA : [cliente_cuelga]\nCliente abandona\nantes de respuesta\n/ registrar abandon_time

EN_CURSO --> EN_ESPERA : [agente_pone_hold]\nAgente presiona hold\n/ iniciar música espera\n/ registrar hold_start

EN_ESPERA --> EN_CURSO : [agente_resume]\nAgente resume llamada\n/ detener música\n/ acumular hold_time

EN_CURSO --> TRANSFERIDA : [agente_transfiere]\nTransferir a otro agente\n/ buscar agente disponible\n/ guardar motivo

TRANSFERIDA --> EN_CURSO : [nuevo_agente_responde]\nNuevo agente acepta\n/ cambiar agente_id\n/ incrementar transfer_count

TRANSFERIDA --> PERDIDA : [transferencia_falla]\nNo hay agentes disponibles\no timeout\n/ registrar fallo

EN_CURSO --> FINALIZADA : [llamada_termina]\nCliente o agente cuelga\nnormalmente\n/ guardar notas\n/ calcular duración

EN_ESPERA --> PERDIDA : [timeout_espera]\nCliente cuelga\nmientras espera\n/ registrar hold_abandon

' =====================================================
' TRANSICIONES EXCEPCIONALES
' =====================================================

EN_CURSO --> PERDIDA : [desconexion_abrupta]\nProblema técnico\nde conectividad\n/ registrar error

TRANSFERIDA --> PERDIDA : [cliente_cuelga]\nCliente cuelga durante\ntransferencia\n/ registrar abandon

' =====================================================
' ESTADOS FINALES
' =====================================================

FINALIZADA --> [*] : Llamada archivada

PERDIDA --> [*] : Llamada archivada

' =====================================================
' NOTAS
' =====================================================

note right of ENTRANTE
  ENTRANTE es el único estado inicial

  Triggers de entrada:
  - Webhook de Twilio
  - API inbound call
  - IVR routing

  Acciones automáticas:
  - Buscar agente disponible
  - Aplicar reglas de routing
  - Inicializar metadata
end note

note bottom of EN_CURSO
  Estado principal de trabajo

  Acciones permitidas:
  - Hold (→ EN_ESPERA)
  - Transfer (→ TRANSFERIDA)
  - Finalizar (→ FINALIZADA)
  - Agregar notas en tiempo real
  - Buscar información del cliente

  Capacidades requeridas:
  - sistema.operaciones.llamadas.atender
end note

note left of EN_ESPERA
  Hold puede ser múltiple

  metadata.hold_events: [
    {
      "hold_start": "2025-11-17T10:30:00Z",
      "hold_end": "2025-11-17T10:32:15Z",
      "duration_seconds": 135
    }
  ]

  Límite de hold: 5 minutos
  Después timeout → PERDIDA
end note

note right of TRANSFERIDA
  Transferencia puede ser:

  1. Directa (a agente específico)
  2. Por habilidad (skill-based)
  3. A supervisor
  4. A departamento externo

  metadata.transfer_history: [
    {
      "from_agent_id": 5,
      "to_agent_id": 12,
      "timestamp": "...",
      "reason": "escalation"
    }
  ]
end note

note bottom of FINALIZADA
  Estado final exitoso

  Triggers post-finalización:
  1. Procesamiento de grabación
  2. Generación de transcripción
  3. Análisis de sentimiento
  4. Cálculo de métricas (CSAT, AHT)
  5. Envío de encuesta cliente

  Auditoría:
  - Duración total
  - Hold time total
  - Transfer count
  - Notas del agente
end note

note top of PERDIDA
  Estado final fallido

  Tipos de pérdida:
  - ABANDON_QUEUE: colgó en cola
  - ABANDON_HOLD: colgó en espera
  - TRANSFER_FAILED: fallo transferencia
  - TECHNICAL_ERROR: problema técnico

  Triggers post-pérdida:
  1. Notificar supervisor
  2. Callback automático (si configurado)
  3. Actualizar métricas de abandono
  4. Registrar en analytics
end note

' =====================================================
' REGLAS DE NEGOCIO
' =====================================================

legend bottom
  REGLAS DE NEGOCIO:

  1. Transiciones irreversibles:
     - No se puede volver de FINALIZADA ni PERDIDA

  2. Tiempo máximo en estados:
     - EN_ESPERA: 5 minutos (después → PERDIDA)
     - TRANSFERIDA: 2 minutos (después → PERDIDA)

  3. Límites de transferencia:
     - Máximo 3 transferencias por llamada
     - Después de 3 → debe finalizar

  4. Grabación:
     - Inicia en ENTRANTE
     - Continúa en EN_ESPERA y TRANSFERIDA
     - Finaliza en FINALIZADA o PERDIDA

  5. Auditoría obligatoria:
     - Todas las transiciones se auditan
     - Timestamp + razón + agente_id

  6. Validaciones:
     - Solo agentes con capacidad
       "sistema.operaciones.llamadas.atender"
       pueden cambiar estados
     - Transferencia requiere capacidad
       "sistema.operaciones.llamadas.transferir"
endlegend

' =====================================================
' EVENTOS Y ACCIONES
' =====================================================

note as N1
  EVENTOS DEL SISTEMA:

  on_entrante:
    - Buscar agente disponible
    - Asignar según skill/routing rules
    - Notificar agente

  on_en_curso:
    - Iniciar timer de duración
    - Activar grabación
    - Cargar datos cliente

  on_hold:
    - Reproducir música espera
    - Iniciar timer de hold
    - Liberar agente (parcial)

  on_transferencia:
    - Notificar nuevo agente
    - Transferir contexto
    - Mantener grabación

  on_finalizacion:
    - Detener grabación
    - Calcular métricas
    - Liberar agente
    - Procesamiento async
end note

@enduml
