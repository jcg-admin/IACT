@startuml CLASS-BACK-010-modelo-permisos
!theme plain
title Modelo de Datos - Sistema de Permisos Granulares
caption Diagrama ER del sistema de permisos sin roles jerárquicos
footer Proyecto IACT | Generado: 2025-11-17 | ADR-GOB-004

' =====================================================
' ENTIDADES PRINCIPALES
' =====================================================

class Funcion {
  + id: Integer <<PK>>
  --
  + nombre: String(100)
  + nombre_completo: String(200) <<UK>>
  + descripcion: Text
  + dominio: String(100)
  + categoria: String(50)
  + icono: String(50)
  + orden_menu: Integer
  + activa: Boolean
  + created_at: DateTime
  + updated_at: DateTime
  --
  Recurso del sistema que agrupa capacidades
  Ejemplo: 'dashboards', 'usuarios', 'métricas'
}

class Capacidad {
  + id: Integer <<PK>>
  --
  + nombre_completo: String(200) <<UK>>
  + descripcion: Text
  + accion: String(50)
  + recurso: String(100)
  + dominio: String(100)
  + nivel_sensibilidad: Enum
  + requiere_auditoria: Boolean
  + activa: Boolean
  + created_at: DateTime
  --
  Acción específica sobre un recurso
  Formato: sistema.dominio.recurso.accion
  Niveles: bajo, normal, alto, critico
}

class FuncionCapacidad {
  + id: Integer <<PK>>
  --
  + funcion_id: Integer <<FK>>
  + capacidad_id: Integer <<FK>>
  + requerida: Boolean
  + visible_en_ui: Boolean
  + created_at: DateTime
  --
  Vincula capacidades con funciones
}

class GrupoPermisos {
  + id: Integer <<PK>>
  --
  + codigo: String(100) <<UK>>
  + nombre_display: String(200)
  + descripcion: Text
  + tipo_acceso: Enum
  + activo: Boolean
  + created_at: DateTime
  + updated_at: DateTime
  --
  Agrupación funcional de capacidades
  SIN jerarquía (NO admin/supervisor/agent)
  Tipos: operativo, gestion, analisis,
         estrategico, tecnico, finanzas, calidad
}

class GrupoCapacidad {
  + id: Integer <<PK>>
  --
  + grupo_id: Integer <<FK>>
  + capacidad_id: Integer <<FK>>
  + created_at: DateTime
  --
  Define capacidades de cada grupo
}

class UsuarioGrupo {
  + id: Integer <<PK>>
  --
  + usuario_id: Integer <<FK>>
  + grupo_id: Integer <<FK>>
  + fecha_asignacion: DateTime
  + fecha_expiracion: DateTime
  + asignado_por_id: Integer <<FK>>
  + activo: Boolean
  --
  Usuario asignado a grupos (múltiples simultáneos)
  Permite asignaciones temporales
  --
  + is_expired(): Boolean
}

class PermisoExcepcional {
  + id: Integer <<PK>>
  --
  + usuario_id: Integer <<FK>>
  + capacidad_id: Integer <<FK>>
  + tipo: Enum
  + fecha_inicio: DateTime
  + fecha_fin: DateTime
  + motivo: Text
  + autorizado_por_id: Integer <<FK>>
  + activo: Boolean
  + created_at: DateTime
  --
  Conceder o revocar capacidad específica
  Tipos: conceder, revocar
  --
  + is_active_now(): Boolean
}

class AuditoriaPermiso {
  + id: Integer <<PK>>
  --
  + usuario_id: Integer <<FK>>
  + capacidad: String(200)
  + accion_realizada: String(100)
  + recurso_accedido: String(200)
  + ip_address: String(50)
  + user_agent: Text
  + metadata: JSONB
  + timestamp: DateTime
  --
  Registro de accesos a recursos protegidos
  Almacena: quién, qué, cuándo, dónde
}

class User {
  + id: Integer <<PK>>
  --
  + username: String
  + email: String
  + status: String
  --
  Usuario del sistema (Django)
}

' =====================================================
' RELACIONES
' =====================================================

' Funcion <-> Capacidad (N:M)
Funcion "1" -- "N" FuncionCapacidad
FuncionCapacidad "N" -- "1" Capacidad

' GrupoPermisos <-> Capacidad (N:M)
GrupoPermisos "1" -- "N" GrupoCapacidad
GrupoCapacidad "N" -- "1" Capacidad

' User <-> GrupoPermisos (N:M)
User "1" -- "N" UsuarioGrupo
UsuarioGrupo "N" -- "1" GrupoPermisos

' User -> UsuarioGrupo (asignado_por)
User "1" .. "N" UsuarioGrupo : asigna >

' User <-> Capacidad (excepcionales)
User "1" -- "N" PermisoExcepcional
PermisoExcepcional "N" -- "1" Capacidad

' User -> PermisoExcepcional (autorizado_por)
User "1" .. "N" PermisoExcepcional : autoriza >

' User -> AuditoriaPermiso
User "1" -- "N" AuditoriaPermiso

' =====================================================
' NOTAS
' =====================================================

note top of GrupoPermisos
  IMPORTANTE: NO son roles jerárquicos
  Son grupos FUNCIONALES y DESCRIPTIVOS
  Un usuario puede tener MÚLTIPLES grupos
  No hay jerarquía entre grupos
end note

note bottom of Capacidad
  Formato nomenclatura:
  sistema.dominio.recurso.accion

  Ejemplos:
  - sistema.vistas.dashboards.ver
  - sistema.operaciones.llamadas.realizar
  - sistema.finanzas.pagos.aprobar
end note

note right of PermisoExcepcional
  Prioridad sobre permisos de grupos:
  1. Revocación activa → NO tiene permiso
  2. Concesión activa → SÍ tiene permiso
  3. Permisos de grupos → según grupos
end note

' =====================================================
' CONSTRAINTS
' =====================================================

note bottom of FuncionCapacidad
  UNIQUE(funcion_id, capacidad_id)
end note

note bottom of GrupoCapacidad
  UNIQUE(grupo_id, capacidad_id)
end note

note bottom of UsuarioGrupo
  UNIQUE(usuario_id, grupo_id)
end note

@enduml
