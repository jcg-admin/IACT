@startuml COMP-BACK-001-arquitectura-general
!theme plain
title Arquitectura de Componentes - Backend Django
caption Vista de componentes principales y dependencias del sistema IACT
footer Proyecto IACT | Generado: 2025-11-17 | ADR-GOB-004

' =====================================================
' CAPAS Y COMPONENTES
' =====================================================

package "API Layer" {
  [API Gateway\nDjango REST Framework] as api_gateway
  [Authentication\nMiddleware] as auth_middleware
  [Permission\nMiddleware] as perm_middleware
  [CORS\nMiddleware] as cors_middleware
}

package "Core Apps - Seguridad" {
  [Authentication\nApp] as auth_app
  [Permissions\nApp] as perm_app
  [Audit\nApp] as audit_app
  [Users\nApp] as users_app
}

package "Core Apps - Operaciones" {
  [Llamadas\nApp] as llamadas_app
  [Clientes\nApp] as clientes_app
  [Horarios\nApp] as horarios_app
  [Equipos\nApp] as equipos_app
}

package "Core Apps - Análisis" {
  [Analytics\nApp] as analytics_app
  [Metricas\nApp] as metricas_app
  [Reportes\nApp] as reportes_app
  [Dashboard\nApp] as dashboard_app
}

package "Core Apps - Soporte" {
  [Tickets\nApp] as tickets_app
  [Notifications\nApp] as notif_app
  [Configuration\nApp] as config_app
  [Excepciones\nApp] as excepciones_app
}

package "Core Apps - Finanzas" {
  [Presupuestos\nApp] as presupuestos_app
  [Politicas\nApp] as politicas_app
}

package "Core Apps - Alertas" {
  [Alertas\nApp] as alertas_app
}

package "Legacy/Integration" {
  [IVR Legacy\nApp] as ivr_app
  [ETL\nApp] as etl_app
  [Common\nUtilities] as common_app
}

package "External Services" {
  [PostgreSQL\nDatabase] as postgres
  [Redis\nCache] as redis
  [S3/Storage\nFiles] as s3
  [Twilio\nTelephony] as twilio
  [SMTP\nEmail] as smtp
}

' =====================================================
' RELACIONES DE DEPENDENCIA
' =====================================================

' API Gateway conecta con middleware
api_gateway --> auth_middleware
api_gateway --> perm_middleware
api_gateway --> cors_middleware

' Middleware conecta con apps de seguridad
auth_middleware --> auth_app
perm_middleware --> perm_app

' Apps de seguridad (core dependencies)
auth_app --> users_app
auth_app --> audit_app
perm_app --> users_app
perm_app --> audit_app

' Apps operacionales dependen de seguridad
llamadas_app --> perm_app
llamadas_app --> users_app
llamadas_app --> clientes_app
llamadas_app --> audit_app

clientes_app --> perm_app
clientes_app --> users_app

horarios_app --> perm_app
horarios_app --> users_app
horarios_app --> equipos_app

equipos_app --> perm_app
equipos_app --> users_app

' Apps de análisis dependen de operaciones
analytics_app --> llamadas_app
analytics_app --> clientes_app
analytics_app --> users_app
analytics_app --> perm_app

metricas_app --> llamadas_app
metricas_app --> analytics_app
metricas_app --> perm_app

reportes_app --> metricas_app
reportes_app --> analytics_app
reportes_app --> perm_app

dashboard_app --> analytics_app
dashboard_app --> metricas_app
dashboard_app --> perm_app

' Apps de soporte
tickets_app --> llamadas_app
tickets_app --> clientes_app
tickets_app --> users_app
tickets_app --> perm_app

notif_app --> users_app

config_app --> perm_app
config_app --> users_app

excepciones_app --> perm_app
excepciones_app --> users_app

' Apps de finanzas
presupuestos_app --> perm_app
presupuestos_app --> users_app

politicas_app --> perm_app
politicas_app --> users_app

' Apps de alertas
alertas_app --> llamadas_app
alertas_app --> metricas_app
alertas_app --> notif_app
alertas_app --> users_app

' Legacy/Integration
ivr_app --> llamadas_app
ivr_app --> clientes_app

etl_app --> llamadas_app
etl_app --> metricas_app
etl_app --> analytics_app

' External Services
users_app --> postgres
auth_app --> postgres
perm_app --> postgres
perm_app --> redis
llamadas_app --> postgres
llamadas_app --> s3
llamadas_app --> twilio
clientes_app --> postgres
analytics_app --> postgres
audit_app --> postgres
notif_app --> postgres
notif_app --> smtp

' =====================================================
' NOTAS
' =====================================================

note top of api_gateway
  Django REST Framework
  - Routing
  - Serialization
  - Validation
  - Error Handling
end note

note right of perm_app
  Sistema de Permisos Granular
  - SIN roles jerárquicos
  - Grupos funcionales
  - Capacidades atómicas
  - Auditoría obligatoria
end note

note bottom of llamadas_app
  Módulo principal operativo
  - Gestión de llamadas
  - Transcripciones
  - Grabaciones
  - Estados y tipos
end note

note left of postgres
  Base de datos principal
  - Django ORM
  - Transacciones ACID
  - Índices optimizados
  - JSON fields (metadata)
end note

note right of redis
  Cache distribuido
  - Permisos de usuario (TTL 5 min)
  - Sesiones activas
  - Rate limiting
  - Locks distribuidos
end note

note bottom of twilio
  Proveedor de telefonía
  - Llamadas entrantes/salientes
  - SMS
  - Conferencias
  - Recording
end note

' =====================================================
' LEYENDA DE DEPENDENCIAS
' =====================================================

legend right
  |<back:lightblue>   </back>| Core Apps - Seguridad |
  |<back:lightgreen>   </back>| Core Apps - Operaciones |
  |<back:lightyellow>   </back>| Core Apps - Análisis |
  |<back:lightpink>   </back>| Core Apps - Soporte |
  |<back:lightcyan>   </back>| Core Apps - Finanzas |
  |<back:lightsalmon>   </back>| Legacy/Integration |
  |<back:lightgray>   </back>| External Services |

  Tipos de dependencia:
  --> : usa / depende de

  Principios:
  - Apps de seguridad NO dependen de apps operacionales
  - Apps operacionales dependen de seguridad
  - Apps de análisis dependen de operaciones
  - Separación clara de capas
endlegend

' =====================================================
' PATRONES ARQUITECTÓNICOS
' =====================================================

note bottom of api_gateway
  PATRONES IMPLEMENTADOS:

  1. Layered Architecture
     - API Layer
     - Business Logic Layer (Apps)
     - Data Layer (Models)

  2. Dependency Injection
     - Services inyectados en Views
     - Middleware chain

  3. Repository Pattern
     - Django ORM como abstracción
     - QuerySets como repositorios

  4. Service Layer
     - AuthenticationService
     - PermisoService
     - Lógica de negocio separada

  5. Observer Pattern
     - Django Signals
     - Post-save hooks
     - Audit logging
end note

@enduml
