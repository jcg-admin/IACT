@startuml UC-003_consultar_estado_pedido_secuencia
!define PRIMARY_COLOR #2C3E50
!define SECONDARY_COLOR #3498DB
!define SUCCESS_COLOR #27AE60

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Cliente" as Cliente
participant "Portal Web" as Portal
participant "API IACT" as API
participant "Base de Datos" as DB
participant "Sistema de\nEnvíos" as Envios
participant "Servicio SMS" as SMS

== Ingreso y Validación ==
Cliente -> Portal: 1. Accede a "Consultar Pedido"
activate Portal
Portal -> Cliente: 2. Muestra formulario\n(Número de pedido)
deactivate Portal

Cliente -> Portal: 3. Ingresa número: PED-2024-5678
activate Portal
Portal -> Portal: 4. Valida formato (PED-YYYY-NNNN)

alt Formato válido
    Portal -> API: 5. GET /api/pedidos/PED-2024-5678
    activate API
    API -> DB: 6. SELECT * FROM pedidos WHERE numero = 'PED-2024-5678'
    activate DB

    alt Pedido existe
        DB --> API: 7. Retorna datos del pedido\n{id, fecha, estado, cliente, items}
        deactivate DB

        == Obtención de Tracking ==
        API -> Envios: 8. GET /tracking/{numeroGuia}
        activate Envios
        Envios --> API: 9. Tracking actual:\n"En tránsito - Llegada estimada: 2024-11-06"
        deactivate Envios

        API --> Portal: 10. Datos completos del pedido + tracking
        deactivate API

        Portal -> Portal: 11. Renderiza línea de tiempo del pedido
        Portal -> Cliente: 12. Muestra estado actual:\n"En tránsito"\nLlegada estimada: 06-Nov-2024
        deactivate Portal

        == Historial Opcional ==
        Cliente -> Portal: 13. Solicita ver historial completo
        activate Portal
        Portal -> API: 14. GET /api/pedidos/PED-2024-5678/historial
        activate API
        API -> DB: 15. SELECT * FROM pedidos_historial WHERE pedido_id = ...
        activate DB
        DB --> API: 16. Retorna eventos:\n[Creado, Confirmado, Enviado, En tránsito]
        deactivate DB
        API --> Portal: 17. Historial completo
        deactivate API

        Portal -> Cliente: 18. Muestra línea de tiempo detallada
        deactivate Portal

        == Notificación SMS Opcional ==
        Cliente -> Portal: 19. Solicita notificación SMS al recibir
        activate Portal
        Portal -> API: 20. POST /api/pedidos/PED-2024-5678/notificaciones\n{tipo: "sms", evento: "entregado"}
        activate API
        API -> DB: 21. INSERT INTO notificaciones_config ...
        activate DB
        DB --> API: 22. Configuración guardada
        deactivate DB
        API --> Portal: 23. Notificación SMS activada
        deactivate API

        Portal -> Cliente: 24. Confirma: "Recibirás SMS al momento de entrega"
        deactivate Portal

    else Pedido no existe
        DB --> API: ERROR: Pedido no encontrado
        deactivate DB
        API --> Portal: 404 - Pedido no existe
        deactivate API
        Portal -> Cliente: "El número de pedido no es válido"
        deactivate Portal
    end

else Formato inválido
    Portal -> Cliente: ERROR: Formato inválido. Use PED-YYYY-NNNN
    deactivate Portal
end

@enduml
