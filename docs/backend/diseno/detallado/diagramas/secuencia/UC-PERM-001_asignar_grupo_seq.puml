@startuml UC-PERM-001_asignar_grupo_seq
' Diagrama de Secuencia - Asignar Grupo de Permisos
' Fecha: 2025-11-09
' Referencia: docs/casos_de_uso/UC-PERM-001_asignar_grupo_a_usuario.md

title Secuencia: Asignar Grupo de Permisos a Usuario

!define SUCCESS #90EE90
!define ERROR #FFB6C1
!define INFO #87CEEB

skinparam sequence {
  ArrowColor #2C3E50
  ActorBorderColor #2C3E50
  LifeLineBorderColor #34495E
  LifeLineBackgroundColor #ECF0F1

  ParticipantBorderColor #2C3E50
  ParticipantBackgroundColor #BDC3C7
  ParticipantFontSize 12

  ActorBackgroundColor #3498DB
  ActorFontColor #FFFFFF
  ActorFontSize 13
}

actor "Administrador" as Admin
participant "Frontend\nReact" as Frontend
participant "API Gateway\nNginx" as Gateway
participant "ViewSet\nUserViewSet" as ViewSet
participant "Middleware\nAuth/Audit" as Middleware
participant "Service\nUsuarioService" as Service
participant "Service\nUserManagementService" as PermService
participant "ORM\nDjango Models" as ORM
database "PostgreSQL" as DB

== 1. Navegación y Selección ==

Admin -> Frontend : Navega a gestión usuarios
activate Frontend

Frontend -> Gateway : GET /api/usuarios/
activate Gateway

Gateway -> ViewSet : Forward request
activate ViewSet

ViewSet -> Middleware : Authenticate
activate Middleware
Middleware -> Middleware : Validate JWT
Middleware --> ViewSet : Authenticated
deactivate Middleware

ViewSet -> ORM : User.objects.filter(is_deleted=False)
activate ORM
ORM -> DB : SELECT * FROM auth_user\nWHERE is_deleted = FALSE
activate DB
DB --> ORM : Users data
deactivate DB
ORM --> ViewSet : QuerySet[User]
deactivate ORM

ViewSet --> Gateway : 200 OK\n[{users}]
deactivate ViewSet
Gateway --> Frontend : Users list
deactivate Gateway

Frontend --> Admin : Muestra lista de usuarios
deactivate Frontend

Admin -> Frontend : Selecciona usuario objetivo
activate Frontend
Frontend --> Admin : Muestra perfil + grupos disponibles
deactivate Frontend

== 2. Selección de Grupos ==

Admin -> Frontend : Selecciona grupos:\n[operadores, analistas]
activate Frontend

Admin -> Frontend : [OPCIONAL] Define fecha expiración
Admin -> Frontend : [OPCIONAL] Ingresa motivo

Admin -> Frontend : Confirma asignación
Frontend --> Admin : Muestra confirmación

== 3. Envío de Request ==

Frontend -> Gateway : POST /api/usuarios/:id/asignar_grupos/\nBody: {\n  "grupos_codigos": ["operadores", "analistas"],\n  "motivo": "Nuevo rol de soporte"\n}
activate Gateway

Gateway -> ViewSet : Forward request
activate ViewSet

== 4. Validación de Autenticación ==

ViewSet -> Middleware : Authenticate & Authorize
activate Middleware

Middleware -> Middleware : Validate JWT token
Middleware -> DB : SELECT id FROM auth_user\nWHERE id = %token_user_id%
activate DB
DB --> Middleware : User authenticated
deactivate DB

Middleware --> ViewSet : User object
deactivate Middleware

== 5. Validación de Serializer ==

ViewSet -> ViewSet : AsignarGruposSerializer
activate ViewSet #LightBlue

ViewSet -> ViewSet : is_valid()

loop Para cada grupo_codigo
  ViewSet -> ORM : GrupoPermiso.objects.filter(codigo=...)
  activate ORM
  ORM -> DB : SELECT id FROM grupos_permisos\nWHERE codigo IN (...)
  activate DB
  DB --> ORM : Grupo exists
  deactivate DB
  ORM --> ViewSet : Validation OK
  deactivate ORM
end

ViewSet --> ViewSet : Serializer validated
deactivate ViewSet

== 6. Llamada al Servicio ==

ViewSet -> Service : asignar_grupos_usuario(\n  usuario_solicitante_id=admin.id,\n  usuario_id=target_user.id,\n  grupos_codigos=["operadores", "analistas"]\n)
activate Service

Service -> PermService : usuario_tiene_permiso(\n  admin.id,\n  "sistema.administracion.usuarios.asignar_grupos"\n)
activate PermService

PermService -> DB : SELECT usuario_tiene_permiso(%s, %s)
activate DB
DB -> DB : Execute PL/pgSQL function
DB --> PermService : TRUE
deactivate DB

PermService --> Service : Permiso verificado
deactivate PermService

alt Administrador SIN permisos [EXCEPCIÓN]
  Service --> ViewSet : PermissionDenied
  activate ViewSet SUCCESS
  ViewSet --> Gateway : 403 Forbidden\n{"error": "Sin permisos"}
  Gateway --> Frontend : Error
  Frontend --> Admin : Muestra error
  deactivate ViewSet
  deactivate Service
  [<-- Note: Flujo termina aquí si sin permisos
else Administrador CON permisos [FLUJO NORMAL]

  Service -> ORM : User.objects.get(id=target_user_id)
  activate ORM
  ORM -> DB : SELECT * FROM auth_user WHERE id = %s
  activate DB
  DB --> ORM : User data
  deactivate DB
  ORM --> Service : User object
  deactivate ORM

  alt Usuario NO existe o inactivo [EXCEPCIÓN]
    Service --> ViewSet : ValidationError
    activate ViewSet ERROR
    ViewSet --> Gateway : 400 Bad Request
    Gateway --> Frontend : Error
    Frontend --> Admin : "Usuario no encontrado"
    deactivate ViewSet
    deactivate Service
    [<-- Note: Flujo termina aquí
  else Usuario válido [CONTINÚA]

    == 7. Transacción de Asignación ==

    Service -> DB : BEGIN TRANSACTION
    activate DB #LightCoral

    loop Para cada grupo_codigo
      Service -> ORM : UsuarioGrupo.objects.get_or_create(\n  usuario=user,\n  grupo=grupo\n)
      activate ORM

      ORM -> DB : SELECT id FROM usuarios_grupos\nWHERE usuario_id=%s AND grupo_id=%s
      DB --> ORM : Result (exists or not)

      alt Grupo YA asignado [FLUJO ALTERNO]
        ORM --> Service : (UsuarioGrupo, created=False)
        Service -> Service : Log: "Grupo ya asignado, ignorando"
      else Grupo NUEVO [FLUJO NORMAL]
        ORM -> DB : INSERT INTO usuarios_grupos (\n  usuario_id, grupo_id,\n  asignado_por_id, fecha_asignacion,\n  fecha_expiracion, activo, motivo\n) VALUES (...)
        DB --> ORM : INSERT OK
        ORM --> Service : (UsuarioGrupo, created=True)
      end

      deactivate ORM
    end

    == 8. Auditoría ==

    Service -> ORM : AuditoriaPermiso.objects.create(\n  usuario=admin,\n  capacidad_codigo="asignacion_grupo",\n  accion="asignacion_grupo",\n  resultado="exito",\n  ip_address=request.META['REMOTE_ADDR'],\n  user_agent=request.META['HTTP_USER_AGENT']\n)
    activate ORM

    ORM -> DB : INSERT INTO auditoria_permisos (...)
    DB --> ORM : Audit record created
    deactivate ORM

    Service -> DB : COMMIT TRANSACTION
    DB --> Service : Transaction committed
    deactivate DB

    Service --> ViewSet : User object (with updated grupos)
    deactivate Service

    == 9. Respuesta al Cliente ==

    ViewSet -> ViewSet : UserSerializer(user).data
    activate ViewSet #SUCCESS

    ViewSet --> Gateway : 200 OK\n{\n  "id": 123,\n  "email": "user@example.com",\n  "grupos": [\n    {"codigo": "operadores", "nombre": "Operadores"},\n    {"codigo": "analistas", "nombre": "Analistas"}\n  ]\n}
    deactivate ViewSet

    Gateway --> Frontend : Response
    deactivate Gateway

    Frontend --> Admin : "Grupos asignados exitosamente"\n+ actualiza vista
    deactivate Frontend
  end
end
deactivate ViewSet

== Resultado Final ==

note over Admin, DB
  **Postcondiciones de éxito**:
  - Registros en usuarios_grupos con activo=TRUE
  - Auditoría registrada con resultado=exito
  - Usuario puede ejercer capacidades inmediatamente
  - Vista vista_grupos_usuario actualizada
end note

@enduml
