@startuml permisos_granular_er
' Diagrama ER del Sistema de Permisos Granular
' Fecha: 2025-11-09
' Referencia: docs/backend/arquitectura/permisos-granular.md

!define TABLE(name) entity name << (T,#FFAAAA) >>
!define PK(field) <b><color:#b8860b><&key></color> field</b>
!define FK(field) <color:#aaaaaa><&link-intact></color> field
!define NN(field) <color:#dark green>field</color>

skinparam linetype ortho
skinparam roundcorner 5
skinparam class {
  BackgroundColor #FFFFDD
  BorderColor #AA

BB00
  ArrowColor #AA7700
}

' =============================================================================
' ENTIDADES PRINCIPALES
' =============================================================================

entity "auth_user" as user {
  PK(id): INTEGER
  --
  NN(username): VARCHAR(150)
  NN(email): VARCHAR(254)
  NN(password): VARCHAR(128)
  is_active: BOOLEAN
  is_staff: BOOLEAN
  is_superuser: BOOLEAN
  date_joined: TIMESTAMP
  last_login: TIMESTAMP
}

entity "funciones" as funcion {
  PK(id): INTEGER
  --
  NN(nombre): VARCHAR(100)
  NN(nombre_completo): VARCHAR(200) [UNIQUE]
  NN(dominio): VARCHAR(100)
  NN(categoria): VARCHAR(50)
  descripcion: TEXT
  icono: VARCHAR(50)
  orden_menu: INTEGER
  activa: BOOLEAN [DEFAULT TRUE]
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}

entity "capacidades" as capacidad {
  PK(id): INTEGER
  --
  NN(codigo): VARCHAR(200) [UNIQUE]
  NN(nombre): VARCHAR(100)
  descripcion: TEXT
  requiere_aprobacion: BOOLEAN
  nivel_riesgo: VARCHAR(20)
  activa: BOOLEAN [DEFAULT TRUE]
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
  --
  CHECK nivel_riesgo IN ('bajo', 'medio', 'alto', 'critico')
}

entity "funcion_capacidades" as funcion_capacidad {
  PK(id): INTEGER
  --
  FK(funcion_id): INTEGER [NN]
  FK(capacidad_id): INTEGER [NN]
  es_requerida: BOOLEAN [DEFAULT TRUE]
  created_at: TIMESTAMP
  --
  UNIQUE (funcion_id, capacidad_id)
}

entity "grupos_permisos" as grupo {
  PK(id): INTEGER
  --
  NN(codigo): VARCHAR(100) [UNIQUE]
  NN(nombre): VARCHAR(150)
  descripcion: TEXT
  NN(categoria): VARCHAR(50)
  requiere_aprobacion: BOOLEAN
  nivel_riesgo: VARCHAR(20)
  activo: BOOLEAN [DEFAULT TRUE]
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
  --
  CHECK nivel_riesgo IN ('bajo', 'medio', 'alto', 'critico')
}

entity "grupo_capacidades" as grupo_capacidad {
  PK(id): INTEGER
  --
  FK(grupo_id): INTEGER [NN]
  FK(capacidad_id): INTEGER [NN]
  created_at: TIMESTAMP
  --
  UNIQUE (grupo_id, capacidad_id)
}

entity "usuarios_grupos" as usuario_grupo {
  PK(id): INTEGER
  --
  FK(usuario_id): INTEGER [NN]
  FK(grupo_id): INTEGER [NN]
  FK(asignado_por_id): INTEGER [NULL]
  fecha_asignacion: TIMESTAMP [DEFAULT NOW()]
  fecha_expiracion: TIMESTAMP [NULL]
  activo: BOOLEAN [DEFAULT TRUE]
  motivo: TEXT
  --
  UNIQUE (usuario_id, grupo_id)
  INDEX idx_usuario_activo (usuario_id, activo)
}

entity "permisos_excepcionales" as permiso_excepcional {
  PK(id): INTEGER
  --
  FK(usuario_id): INTEGER [NN]
  FK(capacidad_id): INTEGER [NN]
  tipo: VARCHAR(20) [NN]
  FK(otorgado_por_id): INTEGER [NULL]
  fecha_inicio: TIMESTAMP [DEFAULT NOW()]
  fecha_expiracion: TIMESTAMP [NULL]
  motivo: TEXT [NN]
  activo: BOOLEAN [DEFAULT TRUE]
  created_at: TIMESTAMP
  --
  CHECK tipo IN ('temporal', 'permanente')
  INDEX idx_permiso_exc_usuario (usuario_id, activo)
}

entity "auditoria_permisos" as auditoria {
  PK(id): INTEGER
  --
  FK(usuario_id): INTEGER [NN]
  NN(capacidad_codigo): VARCHAR(200)
  NN(accion): VARCHAR(50)
  NN(resultado): VARCHAR(20)
  ip_address: INET
  user_agent: VARCHAR(255)
  contexto_adicional: JSONB
  timestamp: TIMESTAMP [DEFAULT NOW(), INDEX]
  --
  CHECK accion IN ('acceso_permitido', 'acceso_denegado',
                    'asignacion_grupo', 'revocacion_grupo',
                    'permiso_excepcional')
  CHECK resultado IN ('exito', 'fallo')
  INDEX idx_auditoria_usuario_time (usuario_id, timestamp)
  INDEX idx_auditoria_cap_time (capacidad_codigo, timestamp)
}

' =============================================================================
' VISTAS SQL (Representación lógica)
' =============================================================================

entity "vista_capacidades_usuario" as vista_cap <<view>> {
  (view)
  --
  usuario_id: INTEGER
  usuario_nombre: VARCHAR
  usuario_email: VARCHAR
  capacidad_id: INTEGER
  capacidad_codigo: VARCHAR
  funcion_nombre: VARCHAR
  funcion_dominio: VARCHAR
  nivel_riesgo: VARCHAR
  origen: VARCHAR
  grupo_origen: VARCHAR
  --
  Consolida capacidades de:
  - Grupos asignados
  - Permisos excepcionales concedidos
  - MENOS permisos revocados
}

entity "vista_grupos_usuario" as vista_grupos <<view>> {
  (view)
  --
  usuario_id: INTEGER
  usuario_nombre: VARCHAR
  usuario_email: VARCHAR
  grupo_id: INTEGER
  grupo_codigo: VARCHAR
  grupo_nombre: VARCHAR
  tipo_acceso: VARCHAR
  color_hex: VARCHAR
  fecha_asignacion: TIMESTAMP
  fecha_expiracion: TIMESTAMP
  vigente: BOOLEAN
  asignado_por_nombre: VARCHAR
  --
  Calcula vigencia automáticamente
}

' =============================================================================
' RELACIONES
' =============================================================================

' Relación Funcion <-> Capacidad (N:M through funcion_capacidades)
funcion ||--o{ funcion_capacidad : "tiene"
capacidad ||--o{ funcion_capacidad : "pertenece a"

' Relación Grupo <-> Capacidad (N:M through grupo_capacidades)
grupo ||--o{ grupo_capacidad : "contiene"
capacidad ||--o{ grupo_capacidad : "asignada a"

' Relación Usuario <-> Grupo (N:M through usuarios_grupos)
user ||--o{ usuario_grupo : "pertenece a"
grupo ||--o{ usuario_grupo : "asignado a"
user ||--o{ usuario_grupo : "asigna (asignado_por)"

' Relación Usuario <-> Permiso Excepcional
user ||--o{ permiso_excepcional : "tiene"
capacidad ||--o{ permiso_excepcional : "otorgada como"
user ||--o{ permiso_excepcional : "otorga (otorgado_por)"

' Relación Usuario <-> Auditoría
user ||--o{ auditoria : "genera logs"

' Vistas SQL (lógica)
user ||..o{ vista_cap : "genera (computed)"
user ||..o{ vista_grupos : "genera (computed)"
capacidad ||..o{ vista_cap : "incluida en (computed)"
grupo ||..o{ vista_grupos : "incluido en (computed)"

' =============================================================================
' NOTAS Y LEYENDA
' =============================================================================

note right of funcion
  **Funciones del Sistema**

  Representa recursos del sistema
  (dashboards, usuarios, reportes)

  Ejemplos:
  - sistema.vistas.dashboards
  - sistema.administracion.usuarios
  - sistema.operaciones.llamadas
end note

note right of capacidad
  **Capacidades Granulares**

  Acciones específicas sobre funciones

  Ejemplos:
  - sistema.vistas.dashboards.ver
  - sistema.admin.usuarios.crear
  - sistema.admin.usuarios.eliminar

  Nivel de riesgo determina
  aprobaciones necesarias
end note

note right of grupo
  **Grupos de Permisos**

  Colección de capacidades
  relacionadas funcionalmente

  NO hay jerarquías

  Ejemplos:
  - administradores_sistema
  - operadores
  - supervisores
  - analistas
end note

note bottom of usuario_grupo
  **Asignaciones Temporales**

  fecha_expiracion NULL = permanente
  fecha_expiracion NOT NULL = temporal

  Las vistas SQL filtran
  automáticamente expirados
end note

note right of permiso_excepcional
  **Permisos Individuales**

  Para casos excepcionales donde
  NO conviene crear un grupo

  Tipo 'conceder': Otorga capacidad
  Tipo 'revocar': Quita capacidad

  Útil para pruebas y emergencias
end note

note bottom of auditoria
  **Auditoría Inmutable**

  Log completo de:
  - Accesos permitidos/denegados
  - Asignaciones de grupos
  - Permisos excepcionales

  GDPR/SOX compliant
  Retención: 7 años
end note

note bottom of vista_cap
  **Vista Consolidada**

  Consulta optimizada que une:
  1. Capacidades de grupos activos
  2. Permisos excepcionales concedidos
  3. MENOS permisos revocados

  Usada por función SQL:
  usuario_tiene_permiso()
end note

' Leyenda
legend right
  |= Símbolo |= Significado |
  | <&key> | Primary Key |
  | <&link-intact> | Foreign Key |
  | <color:#dark green>campo</color> | NOT NULL |
  | ||--o{ | Relación 1:N |
  | ||..o{ | Relación lógica (vista) |
  | <<view>> | Vista SQL |
endlegend

@enduml
