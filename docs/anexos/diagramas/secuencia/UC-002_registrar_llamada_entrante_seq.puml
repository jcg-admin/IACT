@startuml UC-002_registrar_llamada_entrante_secuencia
!define PRIMARY_COLOR #2C3E50
!define SECONDARY_COLOR #3498DB
!define SUCCESS_COLOR #27AE60

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Agente de\nServicio" as Agente
participant "Sistema IACT" as Sistema
participant "API de Llamadas" as API
participant "Sistema\nTelefónico (PBX)" as PBX
participant "Base de Datos" as DB
participant "CRM Externo" as CRM

== Recepción de Llamada ==
PBX -> Sistema: 1. Notifica llamada entrante\n(ANI: +52-555-1234, DNIS: +52-800-5678)
activate Sistema
Sistema -> Sistema: 2. Captura datos de telefonía
Sistema -> Agente: 3. Muestra notificación emergente\n"Llamada entrante de +52-555-1234"
deactivate Sistema

Agente -> Sistema: 4. Acepta llamada
activate Sistema
Sistema -> PBX: 5. Confirma conexión
activate PBX
PBX --> Sistema: 6. Llamada conectada
deactivate PBX

== Identificación de Cliente ==
Sistema -> API: 7. GET /api/clientes?telefono=+52-555-1234
activate API
API -> DB: 8. SELECT cliente WHERE telefono = '+52-555-1234'
activate DB
DB --> API: 9. Retorna datos del cliente (ID: C-12345, Nombre: Juan Pérez)
deactivate DB
API --> Sistema: 10. Datos del cliente
deactivate API

Sistema -> Agente: 11. Muestra ficha del cliente en pantalla
deactivate Sistema

== Registro de Llamada ==
Agente -> Sistema: 12. Inicia registro de llamada
activate Sistema
Sistema -> Agente: 13. Muestra formulario de registro
deactivate Sistema

Agente -> Sistema: 14. Ingresa datos:\n- Motivo: "Consulta de saldo"\n- Categoría: "Información"\n- Notas: "Cliente solicita..."
activate Sistema
Sistema -> Sistema: 15. Valida datos obligatorios

alt Datos válidos
    Sistema -> API: 16. POST /api/llamadas\n{clienteId, motivo, categoria, duracion, ...}
    activate API
    API -> DB: 17. INSERT INTO llamadas VALUES (...)
    activate DB
    DB --> API: 18. Registro creado (ID: LL-98765)
    deactivate DB
    API --> Sistema: 19. Llamada registrada exitosamente
    deactivate API

    == Sincronización con CRM (Extensión Opcional) ==
    Sistema -> CRM: 20. POST /api/crm/interacciones\n{clienteId, tipo, fecha, ...}
    activate CRM
    CRM --> Sistema: 21. Sincronización exitosa
    deactivate CRM

    Sistema -> Agente: 22. Confirma registro (ID: LL-98765)\nSincronizado con CRM
    deactivate Sistema

else Datos incompletos
    Sistema -> Agente: ERROR: Faltan campos obligatorios (motivo, categoría)
    deactivate Sistema
end

== Finalización ==
Agente -> Sistema: 23. Finaliza llamada
activate Sistema
Sistema -> PBX: 24. Desconecta llamada
activate PBX
PBX --> Sistema: 25. Llamada terminada (duración: 3m 45s)
deactivate PBX

Sistema -> API: 26. PATCH /api/llamadas/LL-98765\n{duracion: 225, estado: "finalizada"}
activate API
API -> DB: 27. UPDATE llamadas SET duracion=225, estado='finalizada'
activate DB
DB --> API: 28. Actualizado
deactivate DB
API --> Sistema: 29. Llamada actualizada
deactivate API

Sistema -> Agente: 30. Muestra resumen de llamada
deactivate Sistema

@enduml
