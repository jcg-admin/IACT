@startuml UC-PERM-008 Generar Menú Dinámico
!theme plain
title UC-PERM-008: Generar Menú Dinámico\nBasado en Capacidades del Usuario

participant "Frontend\nReact App" as fe
participant "API\nBackend" as api
participant "SQL\nFunction" as func
database "PostgreSQL" as db
participant "Cache" as cache

== Fase 1: Solicitud de Menú (Primera Carga) ==

fe -> api: GET /api/permisos/verificar/123/menu/\nAuthorization: Bearer <token>
activate api

api -> cache: GET menu:user:123
cache --> api: [MISS] No existe en cache

api -> func: SELECT obtener_menu_usuario(123)
activate func

func -> db: -- Paso 1: Obtener todas las capacidades\nSELECT capacidad_codigo\nFROM vista_capacidades_usuario\nWHERE usuario_id = 123
activate db

db --> func: [\n  "sistema.vistas.dashboards.ver",\n  "sistema.vistas.dashboards.editar",\n  "sistema.vistas.reportes.ver",\n  "sistema.vistas.reportes.crear",\n  "sistema.vistas.reportes.exportar",\n  "sistema.vistas.calidad.ver",\n  "sistema.administracion.usuarios.ver"\n]

note right of func
  Paso 2: Parsear estructura jerárquica

  Formato capacidad:
  "dominio.subdominio.funcion.accion"
  └─┬──┘ └───┬───┘ └──┬─┘ └─┬┘
    0       1        2     3
  sistema  vistas  dashboards ver
end note

func -> func: -- Procesar con SQL\nSELECT\n  split_part(cap, '.', 2) AS dominio,\n  split_part(cap, '.', 3) AS funcion,\n  split_part(cap, '.', 4) AS accion\nFROM unnest(capacidades_array) AS cap\nGROUP BY dominio, funcion

func -> db: -- Construir estructura JSON anidada\nSELECT jsonb_object_agg(\n  dominio,\n  jsonb_object_agg(\n    funcion,\n    array_agg(accion)\n  )\n)

db --> func: {\n  "vistas": {\n    "dashboards": ["ver", "editar"],\n    "reportes": ["ver", "crear", "exportar"],\n    "calidad": ["ver"]\n  },\n  "administracion": {\n    "usuarios": ["ver"]\n  }\n}

deactivate db
deactivate func

== Fase 2: Cache y Respuesta ==

api -> cache: SET menu:user:123\nEX 300  (TTL=5 min)
cache --> api: ✓ Cached

api --> fe: HTTP 200:\n{\n  "vistas": {...},\n  "administracion": {...}\n}
deactivate api

== Fase 3: Renderizado del Menú ==

fe -> fe: Parsear estructura JSON
activate fe

note right of fe
  React Component:

  ```tsx
  const { menu, loading } = useMenu();

  return (
    <nav>
      {Object.entries(menu).map(([dominio, funciones]) => (
        <MenuSection key={dominio} title={dominio}>
          {Object.entries(funciones).map(([funcion, acciones]) => (
            <MenuItem
              to={`/${dominio}/${funcion}`}
              actions={acciones}
            />
          ))}
        </MenuSection>
      ))}
    </nav>
  );
  ```
end note

fe -> fe: Construir árbol de navegación

participant "Usuario" as user

fe --> user: Muestra menú dinámico:\n┌─ Vistas\n│  ├─ Dashboards (ver, editar)\n│  ├─ Reportes (ver, crear, exportar)\n│  └─ Calidad (ver)\n└─ Administración\n   └─ Usuarios (ver)

deactivate fe

== Fase 4: Navegación del Usuario ==

user -> fe: Click en "Reportes"
activate fe
fe -> fe: Verificar acciones disponibles\nacciones = ["ver", "crear", "exportar"]

fe --> user: Muestra página de Reportes con:\n- Botón "Ver" (visible)\n- Botón "Crear" (visible)\n- Botón "Exportar" (visible)\n- Botón "Eliminar" (OCULTO - no tiene permiso)

deactivate fe

== Fase 5: Cache Hit en Siguientes Cargas ==

note over fe, cache
  Usuario navega a otra página y regresa...
end note

fe -> api: GET /api/permisos/verificar/123/menu/\n(segunda vez, dentro de 5 min)
activate api

api -> cache: GET menu:user:123
cache --> api: [HIT] {\n  "vistas": {...},\n  "administracion": {...}\n}

note right of api
  Cache HIT:
  - No consulta a DB
  - Latencia: < 5ms
  - Performance óptima
end note

api --> fe: HTTP 200: (desde cache)
deactivate api

fe --> user: Renderiza menú (< 5ms)

== Fase 6: Invalidación por Cambio de Permisos ==

participant "Admin" as admin
participant "Admin\nAPI" as admin_api

admin -> admin_api: POST /api/usuarios/123/grupos/\n{"grupo_id": 5} (asignar nuevo grupo)
activate admin_api

admin_api -> db: INSERT INTO usuarios_grupos\n(usuario_id=123, grupo_id=5, activo=TRUE)
db --> admin_api: ✓ Inserted

admin_api -> cache: DEL menu:user:123\nDEL permisos:user:123\nDEL capacidades:user:123
cache --> admin_api: ✓ Cache invalidado

admin_api --> admin: HTTP 201: Grupo asignado
deactivate admin_api

note over user
  Próxima vez que usuario
  cargue el menú:

  1. Cache MISS
  2. Consulta a DB
  3. Nuevo menú con capacidades actualizadas
  4. Aparecen nuevas opciones
end note

user -> fe: Recarga página / Navigate
fe -> api: GET /api/permisos/verificar/123/menu/
api -> cache: GET menu:user:123
cache --> api: [MISS] (invalidado)

api -> func: SELECT obtener_menu_usuario(123)
func -> db: Query (con nuevas capacidades)
db --> func: {\n  "vistas": {...},\n  "administracion": {\n    "usuarios": ["ver", "crear", "editar"],  ← NUEVAS\n    "grupos": ["ver", "crear"]                ← NUEVAS\n  }\n}
func --> api: Menú actualizado
api --> fe: HTTP 200
fe --> user: Muestra menú ampliado con nuevas opciones

== Performance Metrics ==

note over fe, db
  PERFORMANCE:
  ┌────────────────────────┬──────────┐
  │ Escenario              │ Latencia │
  ├────────────────────────┼──────────┤
  │ Cache HIT              │ < 5ms    │
  │ Cache MISS (SQL func)  │ 20-40ms  │
  │ Renderizado React      │ 10-20ms  │
  │ Total (cache HIT)      │ < 30ms   │
  │ Total (cache MISS)     │ 40-80ms  │
  └────────────────────────┴──────────┘

  ESTRUCTURA CAPACIDAD:
  sistema . vistas . dashboards . ver
  └──┬──┘ └──┬──┘ └────┬────┘ └─┬┘
  dominio sub   funcion    accion
  (fijo) (nivel) (módulo) (permiso)

  MAPEO AL MENÚ:
  - dominio: Sección principal (Vistas, Admin)
  - subdominio: Subsección
  - funcion: Item del menú (Dashboards)
  - accion: Botones/acciones (ver, crear, editar)
end note

@enduml
